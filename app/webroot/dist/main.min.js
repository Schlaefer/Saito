"undefined"==typeof console&&(console={},console.log=function(){"use strict"},console.error=console.debug=console.info=console.log),window.redirect=function(e){"use strict";document.location.replace(e)},$.ajaxSetup({cache:!1}),define("jquery",[],function(){"use strict";return jQuery}),define("lib/bootstrapHelper",function(){}),define("lib/saito/underscore.extend",["underscore"],function(e){"use strict";e.mixin({chars:function(e){var t,i;return i=e.match(/(\uD83C[\uDF00-\uDFFF]|\uD83D[\uDC00-\uDFFF])/g)||[],t=e.length-i.length}})}),define("app/core",["marionette"],function(e){"use strict";return new e.Application}),define("app/vent",["marionette"],function(){var e=function(){this.vent=new Backbone.Wreqr.EventAggregator,this.commands=new Backbone.Wreqr.Commands,this.reqres=new Backbone.Wreqr.RequestResponse,this.request=function(){var e=Array.prototype.slice.apply(arguments);return this.reqres.request.apply(this.reqres,e)}};return new e}),define("models/appSetting",["underscore","backbone"],function(e,t){"use strict";var i=t.Model.extend({});return i}),define("models/appStatus",["underscore","backbone","cakeRest","app/vent"],function(e,t,i,n){"use strict";var o=t.Model.extend({stream:null,initialize:function(t,i){this.settings=i.settings,this.methodToCakePhpUrl=e.clone(this.methodToCakePhpUrl),this.methodToCakePhpUrl.read="status/",this.listenTo(this,"change:lastShoutId",this._onNewShout)},start:function(){this._setWebroot(this.settings.get("webroot")),this._poll()},_onNewShout:function(e){var t=e.get("lastShoutId");n.commands.execute("shoutbox:update",t)},_setWebroot:function(e){this.webroot=e+"status/"},_eventStream:function(){this.stream=new EventSource(this.webroot+this.methodToCakePhpUrl.read),this.stream.addEventListener("message",e.bind(function(e){var t=JSON.parse(e.data);this.set(t)},this),!1)},_poll:function(){var t,i,n,o,s,r,a=1e4,l=9e4;s=function(){void 0!==o&&clearTimeout(o)},t=function(){s(),r=a},n=function(){o=setTimeout(i,r)},i=e.bind(function(){n(),this.fetch({success:function(){r=Math.floor(r*(1+r/4e4)),r>l&&(r=l)},error:s})},this),this.listenTo(this,"change",function(){t(),n()}),i(),t(),n()}});return e.extend(o.prototype,i),o}),define("models/currentUser",["underscore","backbone"],function(e,t){"use strict";var i=t.Model.extend({isLoggedIn:function(){return this.get("id")>0}});return i}),define("models/app",["underscore","backbone","app/vent","models/appSetting","models/appStatus","models/currentUser"],function(e,t,i,n,o,s){"use strict";var r=t.Model.extend({eventBus:null,settings:null,status:null,currentUser:null,request:null,initialize:function(){this.eventBus=i.vent,this.commands=i.commands,this.reqres=i.reqres,this.settings=new n,this.status=new o({},{settings:this.settings}),this.currentUser=new s}});return new r}),define("modules/html5-notification/views/notification",["underscore","backbone","models/app"],function(e,t,i){"use strict";var n=t.View.extend({_hideAfter:10,_iconUrl:!1,initialize:function(e){this._iconUrl=e.iconUrl,this.listenTo(i.eventBus,"html5-notification",this.notification),i.commands.setHandler("app:html5-notification:activate",this._activate,this),i.reqres.setHandler("app:html5-notification:available",this._isEnabled,this)},notification:function(t){var n=!i.reqres.request("isAppVisible");if(t=e.defaults(t,{icon:this._iconUrl,always:!1}),t.always||n){var o=new window.Notification(t.title,{icon:t.icon,body:t.message}),s=navigator.userAgent.toLowerCase().indexOf("chrome")>-1;s&&setTimeout(function(){o.close()},1e3*this._hideAfter)}},_activate:function(){return"permission"in window.Notification&&"granted"!==window.Notification.permission?void window.Notification.requestPermission():void window.Notification.requestPermission()},_isEnabled:function(){return"Notification"in window?!0:!1}});return n}),define("modules/html5-notification/html5-notification",["app/core","marionette","modules/html5-notification/views/notification"],function(e,t,i){"use strict";var n=e.module("html5-notification");return n.addInitializer(function(e){new i({iconUrl:e.SaitoApp.app.settings.notificationIcon})}),n}),define("modules/shoutbox/models/shout",["underscore","backbone"],function(e,t){"use strict";var i=t.Model.extend({initialize:function(e,t){this.urlRoot=t.urlRoot}});return i}),define("modules/shoutbox/collections/shouts",["underscore","backbone","modules/shoutbox/models/shout"],function(e,t,i){"use strict";var n=t.Collection.extend({model:i,initialize:function(e,t){this.apiroot=t.apiroot+"shouts/"},fetch:function(){$.ajax({url:this.apiroot,dataType:"json",context:this}).done(function(e){e.length>0&&this.reset(e)})}});return n}),define("templateHelpers",["jquery","underscore","app/vent","moment"],function(e,t,i,n){"use strict";var o=function(){this.webroot=i.reqres.request("webroot")};return{Time:t.extend(new o,{moment:n,_timeFormats:{"long":"DD.MM.YYYY",longWithTime:"DD.MM.YYYY HH:mm",RFC3339:"YYYY-MM-DDTHH:mm:ssZ",theRightWay:"YYYY-MM-DD HH:mm:ss",time:"HH:mm"},lastMidnight:function(){return n(this.now().format("YYYY-MM-DD"))},now:function(){return n()},_normal:function(t){var i=this.now(),n=this.lastMidnight(),o=i.diff(t)/1e3;return t.isAfter(n)||21600>o?t.format(this._timeFormats.time):64800>o?e.i18n.__("yesterday")+" "+t.format(this._timeFormats.time):t.format(this._timeFormats["long"])},format:function(e,i,o){var s,r;if(i=i||"normal",o=o||{},t.defaults(o,{wrap:!0}),n.isMoment(e))r=e;else if(t.isNumber(e))(""+e).length<13&&(e=Math.round(1e3*e)),r=new n(e);else{if(!t.isDate(e))throw"No valid timestamp: "+e.toJSON();r=new n(e)}if(s="normal"===i?this._normal(r):r.format(this._timeFormats[i]?this._timeFormats[i]:i),o.wrap){var a=" ",l={title:r.format(this._timeFormats.theRightWay),datetime:r.format(this._timeFormats.RFC3339)};t.each(l,function(e,t){a+=t+'="'+e+'" '}),s="<time"+a+">"+s+"</time>"}return s}}),User:t.extend(new o,{templates:{linkToUserProfile:t.template('<a href="<%- url %>"><%- name %></a>')},linkToUserProfile:function(e,t){var i=this.urlToUserProfile(e);return this.templates.linkToUserProfile({url:i,name:t})},urlToUserProfile:function(e){return this.webroot+"users/view/"+e}})}}),define("lib/saito/localStorageHelper",["underscore","app/vent"],function(e,t){"use strict";var i=function(){};e.extend(i.prototype,{_available:null,_prefix:"saito-",available:function(){return null===this._available&&(this._available=this._isAvailable()),this._available},_clear:function(){if(this.available()){var t=Object.keys(localStorage);e.each(t,function(e){0===e.indexOf(this._prefix)&&localStorage.removeItem(e)},this)}},_key:function(e){return this._prefix+e},_isAvailable:function(){if(!("localStorage"in window))return!1;try{var e="localStorageAvailableTestKey",t=window.localStorage;return t.setItem(e,"1"),t.removeItem(e),!0}catch(i){return!1}return!1}});var n=new i;t.reqres.setHandler("app:localStorage:available",n.available,n),t.reqres.setHandler("app:localStorage:key",n._key,n),t.commands.setHandler("app:localStorage:clear",n._clear,n)}),define("modules/shoutbox/models/control",["underscore","backbone","models/app","lib/saito/localStorageHelper"],function(e,t,i){"use strict";var n=t.Model.extend({defaults:{id:1,lastId:0,mar:0,notify:!1},localStorage:function(){var e=i.reqres.request("app:localStorage:key","shoutbox-control");return new t.LocalStorage(e)}(),initialize:function(){this._restore(["notify","mar"]),this.listenTo(this,"change:notify",this._onChangeNotify),i.commands.setHandler("shoutbox:mar",this._mar,this)},_mar:function(t){t=t||{},e.defaults(t,{silent:!1}),this.set({mar:this.get("lastId")},{silent:t.silent}),this._save("mar")},setLastId:function(e){e<=this.get("lastId")||this.set("lastId",e)},_onChangeNotify:function(){this._save("notify")},_onChangeMar:function(){this._save("mar")},_restore:function(t){e.isArray(t)&&e.each(t,function(e){this._restore(e)},this),i.reqres.request("app:localStorage:available")&&this.fetch()},_save:function(){i.reqres.request("app:localStorage:available")&&this.save()}});return new n}),define("text!modules/shoutbox/templates/shout.html",[],function(){return'<span class="username">\n    <%= User.linkToUserProfile(user_id, user_name) %>:\n</span>\n<%= html %>\n'}),define("modules/shoutbox/views/shout",["jquery","underscore","backbone","marionette","models/app","modules/shoutbox/models/control","templateHelpers","text!modules/shoutbox/templates/shout.html"],function(e,t,i,n,o,s,r,a){"use strict";var l=n.ItemView.extend({className:"shout",templateHelpers:r,initialize:function(e){this.webroot=e.webroot,this.listenTo(s,"change:mar",this.render)},serializeData:function(){var e=this.model.toJSON(),t=this.model.get("id")>s.get("mar"),i=this.model.get("user_id")===o.currentUser.get("id");return i&&this.$el.addClass("shoutbox-shout-cu"),this.$el.addClass(t&&!i?"shoutbox-shout-new":"shoutbox-shout-old"),e},onRender:function(){s.setLastId(this.model.get("id"))},template:function(e){return t.template(a,e)}});return l}),define("modules/shoutbox/views/shouts",["jquery","underscore","backbone","marionette","models/app","templateHelpers","modules/shoutbox/views/shout","modules/shoutbox/models/control"],function(e,t,i,n,o,s,r,a){"use strict";var l=n.CollectionView.extend({itemView:r,itemViewOptions:{},_Notifications:{_last:0,_models:[],_isEnabled:!1,init:function(e){this._currentUserId=e.currentUserId,this._isEnabled=e.isEnabled,this._last=e.last},add:function(e){this._isEnabled===!0&&this._currentUserId!==e.get("user_id")&&(e.get("id")<=this._last||this._models.push(e))},send:function(){0!==this._models.length&&(t.each(this._models,function(e){o.eventBus.trigger("html5-notification",{title:e.get("user_name"),message:e.get("text")})}),this._last=t.first(this._models).get("id"),this._models=[])}},_Delimiter:{_conversationCoolOff:300,_previousItemTime:null,tpl:t.template('<div class="infoText"><%= time %></div>'),append:function(e){var t=s.Time.moment(e.model.get("time"));return null===this._previousItemTime?void(this._previousItemTime=t):(this._itemTime=t,this.$el=e.$el,this._prepend(this._previousItemTime.unix()-t.unix()>this._conversationCoolOff?this._previousItemTime:"<hr>"),void(this._previousItemTime=t))},finish:function(){this._previousItemTime=null,this._itemTime&&this.$el.after(this._formatTime(this._itemTime))},_prepend:function(e){this.$el.before(this._formatTime(e))},_formatTime:function(e){var i=e;if(t.isObject(e)){var n=s.Time.moment().utc().diff(e)/1e3,o="normal";n>64800&&(o="longWithTime"),i=this.tpl({time:s.Time.format(e,o)})}return i}},initialize:function(e){this.itemViewOptions.webroot=e.webroot,this.setupNotifications(),this.listenTo(a,"change:notify",this.setupNotifications)},setupNotifications:function(){var e=0;this.collection.size()>0&&(e=this.collection.first().get("id")),this._Notifications.init({currentUserId:o.currentUser.get("id"),isEnabled:a.get("notify"),last:e})},onBeforeRender:function(){this.$el.html("")},onAfterItemAdded:function(e){this._Delimiter.append(e),this._Notifications.add(e.model)},onRender:function(){this._Delimiter.finish(),this._Notifications.send()}});return l}),define("text!modules/shoutbox/templates/add.html",[],function(){return'<form>\n    <textarea id="shoutbox-input" maxlength="255" rows="1"\n            placeholder="<%= placeholder %>"></textarea>\n</form>\n'}),define("modules/shoutbox/views/add",["jquery","underscore","backbone","marionette","models/app","modules/shoutbox/models/shout","text!modules/shoutbox/templates/add.html","jqueryAutosize"],function(e,t,i,n,o,s,r){"use strict";var a=n.ItemView.extend({template:t.template(r),_placeholder:{a:e.i18n.__("Shout :shortcut",{shortcut:"⌃s"}),b:e.i18n.__("Hit enter to mark as read")},events:{"keyup form":"formUp","keydown form":"formDown","blur #shoutbox-input":"_setPlaceholder","focus #shoutbox-input":"_setPlaceholder"},submit:function(){this.model.save({text:this.textarea.val()},{success:t.bind(function(e,t){o.commands.execute("shoutbox:mar",{silent:!0}),this.collection.reset(t)},this)})},_setPlaceholder:function(){t.defer(t.bind(function(){var e;e=this.textarea.is(":focus")?this._placeholder.b:this._placeholder.a,this.textarea.attr("placeholder",e)},this))},_firefoxRowFix:function(){if(-1!==navigator.userAgent.toLowerCase().indexOf("firefox")){var e=parseFloat(this.textarea.css("line-height")),t=1*this.textarea.attr("rows");this.textarea.css("height",t*e)}},serializeData:function(){return{placeholder:this._placeholder.a}},clearForm:function(){this.textarea.val("").trigger("autosize.resize")},formDown:function(e){13===e.keyCode&&e.shiftKey===!1&&(e.preventDefault(),this.textarea.val().length>0?(this.submit(),this.clearForm()):o.commands.execute("shoutbox:mar"))},formUp:function(){this.textarea.val().length>0?o.eventBus.trigger("breakAutoreload"):0===this.textarea.val().length&&o.eventBus.trigger("initAutoreload")},onShow:function(){this.textarea=this.$("#shoutbox-input"),this._firefoxRowFix(),this.textarea.autosize(),this._setPlaceholder(),e(window).keydown(t.bind(function(e){e.ctrlKey===!0&&83===e.which&&this.textarea.focus()},this))}});return a}),define("text!modules/shoutbox/templates/control.html",[],function(){return"<label id='shoutbox-notify-label' for='shoutbox-notify' style=\"display: none;\">\n    <input id='shoutbox-notify' type='checkbox'>\n    <%- n %>\n</label>\n"}),define("modules/shoutbox/views/control",["jquery","underscore","backbone","marionette","models/app","modules/shoutbox/models/control","text!modules/shoutbox/templates/control.html"],function(e,t,i,n,o,s,r){"use strict";var a=n.ItemView.extend({template:t.template(r),events:{"click #shoutbox-notify":"onChangeNotify"},initialize:function(){this.model=s},onRender:function(){this._putNotifyCheckbox()},serializeData:function(){return{n:e.i18n.__("Notification")}},_putNotifyCheckbox:function(){var e=o.reqres.request("app:html5-notification:available");e===!0&&(this.notify=this.$("#shoutbox-notify"),this.model.get("notify")?this.notify.attr("checked","checked"):this.notify.removeAttr("checked"),this.$("#shoutbox-notify-label").show())},onChangeNotify:function(){var e=this.notify.is(":checked");this.model.set("notify",e),e&&o.commands.execute("app:html5-notification:activate")}});return a}),define("text!modules/shoutbox/templates/layout.html",[],function(){return"<div>\n    <div id='shoutbox-add'></div>\n    <div id='shoutbox-shouts'></div>\n    <div id='shoutbox-control'></div>\n</div>\n"}),define("modules/shoutbox/shoutbox",["jquery","app/app","models/app","marionette","modules/shoutbox/collections/shouts","modules/shoutbox/models/shout","modules/shoutbox/views/shouts","modules/shoutbox/views/add","modules/shoutbox/views/control","text!modules/shoutbox/templates/layout.html"],function(e,t,i,n,o,s,r,a,l,d){"use strict";var c=t.module("Shoutbox");return c.addInitializer(function(t){var c=t.SaitoApp.shouts,u=i.reqres.request("webroot"),h=i.reqres.request("apiroot");if(e("#shoutbox").length){var p={layout:null,shoutsCollection:null,initialize:function(){this.initLayout(),this.initShoutsCollection(),this.initAdd(),this.initShouts(),this.initControl()},initShoutsCollection:function(){this.shoutsCollection=new o(c,{apiroot:h});var e=_.bind(function(){var e=!i.reqres.request("slidetab:open","shoutbox");e||this.shoutsCollection.fetch()},this);i.eventBus.on("slidetab:open",_.bind(function(t){"shoutbox"===t.slidetab&&e()},this)),i.commands.setHandler("shoutbox:update",_.bind(function(t){var i=0;this.shoutsCollection.size()>0&&(i=this.shoutsCollection.at(0).get("id")),t!==i&&e()},this))},initLayout:function(){var e=n.Layout.extend({el:"#shoutbox",template:d,regions:{add:"#shoutbox-add",shouts:"#shoutbox-shouts",control:"#shoutbox-control"}});this.layout=new e,this.layout.render(),this.layout.$("#shoutbox-add").addClass("slidetab-header"),this.layout.$("#shoutbox-shouts").addClass("slidetab-content"),this.layout.$("#shoutbox-control").addClass("slidetab-footer")},initShouts:function(){var e=new r({collection:this.shoutsCollection,webroot:u});this.layout.shouts.show(e)},initControl:function(){var e=new l;this.layout.control.show(e)},initAdd:function(){var e=new s({},{urlRoot:h+"shouts/"});this.layout.add.show(new a({model:e,collection:this.shoutsCollection}))}};p.initialize()}}),c}),define("models/threadline",["underscore","backbone","models/app","cakeRest"],function(e,t,i,n){"use strict";var o=t.Model.extend({defaults:{isInlineOpened:!1,shouldScrollOnInlineOpen:!0,isAlwaysShownInline:!1,isNewToUser:!1,posting:"",html:""},initialize:function(){this.webroot=i.settings.get("webroot")+"entries/",this.methodToCakePhpUrl=e.clone(this.methodToCakePhpUrl),this.methodToCakePhpUrl.read="threadLine/",this.set("isAlwaysShownInline",i.currentUser.get("user_show_inline")||!1)}});return e.extend(o.prototype,n),o}),define("collections/threadlines",["underscore","backbone","models/threadline"],function(e,t,i){var n=t.Collection.extend({model:i});return n}),define("text!templates/threadline-spinner.html",[],function(){return'<div class="js-thread_inline thread_inline" style="display:none">\n	<div class="js-btn-strip btn-strip btn-strip-top pointer">\n		<i class="fa fa-close-widget"></i>\n	</div>\n	<div class="threadInline-slider">\n	</div>\n</div>'}),define("views/postingActionBookmark",["jquery","underscore","marionette","models/app"],function(e,t,i,n){"use strict";return i.ItemView.extend({tagName:"a",className:"btn-bookmark-add btn-icon panel-footer-form-btn",template:t.template('<i class="fa fa-lg"></i>'),events:{click:"_onClick"},modelEvents:{"change:isBookmarked":"_toggle"},initialize:function(){this._shouldRender()&&(this.$el.attr("href","#"),this.render())},_shouldRender:function(){return n.currentUser.isLoggedIn()?!0:!1},_onClick:function(e){e.preventDefault(),this.model.get("isBookmarked")?window.location=n.settings.get("webroot")+"bookmarks/index/#"+this.model.get("id"):this.model.set("isBookmarked",!0)},_toggle:function(){var t=this.$("i");this.model.get("isBookmarked")?(t.removeClass("fa-bookmark-o"),t.addClass("fa-bookmark"),this.$el.attr("title",e.i18n.__("Entry is bookmarked"))):(t.removeClass("fa-bookmark"),t.addClass("fa-bookmark-o"),this.$el.attr("title",e.i18n.__("Bookmark the entry")))},onRender:function(){this._toggle()}})}),define("views/postingActionSolves",["jquery","marionette","models/app"],function(e,t,i){"use strict";return t.ItemView.extend({tagName:"a",className:"btn-solves btn-icon panel-footer-form-btn",template:_.template('<i class="fa fa-badge-solves-o fa-lg"></i>'),events:{click:"_onClick"},modelEvents:{"change:isSolves":"_toggle"},initialize:function(){this._shouldRender()&&(this.$el.attr({href:"#",title:e.i18n.__("Mark entry as helpful")}),this.render())},_shouldRender:function(){return i.currentUser.isLoggedIn()?this.model.isRoot()?!1:this.model.get("rootEntryUserId")!==i.currentUser.get("id")?!1:!0:!1},_onClick:function(e){e.preventDefault(),this.model.toggle("isSolves")},_toggle:function(){var t=this.$("i"),i=this.model.get("isSolves"),n="";i?(t.addClass("solves-isSolved"),t.removeClass("fa-badge-solves-o"),t.addClass("fa-badge-solves"),n=this.$el.html(),n=e(n).removeClass("fa-lg")):(t.removeClass("fa-badge-solves"),t.addClass("fa-badge-solves-o"),t.removeClass("solves-isSolved")),this._toggleGlobal(n)},_toggleGlobal:function(t){var i=e(".solves."+this.model.get("id"));i.html(t)},onRender:function(){this._toggle()}})}),define("views/editCountdown",["jquery","underscore","marionette","moment","jqueryTinyTimer"],function(e,t,i,n){"use strict";return i.ItemView.extend({_editEnd:null,_buttonText:null,_$countdownDummy:null,_doneAction:"remove",initialize:function(t){this._editEnd=n(this.model.get("time")).unix()+60*t.editPeriod,n().unix()>this._editEnd||(t.done&&(this._doneAction=t.done),this._buttonText=this.$el.html(),this._$countdownDummy=e('<span style="display: none;"></span>'),this.$el.append(this._$countdownDummy),this._start())},_setButtonText:function(e){this.$el.text(this._buttonText+" "+e)},_onTick:function(e){e.m>1||1===e.m&&e.s>30?(e.m=e.m+1,this._setButtonText("("+e.m+" min)")):this._setButtonText(1===e.m?"("+e.m+" min "+e.s+" s)":"("+e.s+" s)")},_onEnd:function(){switch(this._doneAction){case"disable":this._disable();break;default:this._remove()}},_remove:function(){this.remove()},_disable:function(){this.$el.attr("disabled","disabled")},_start:function(){this._$countdownDummy.tinyTimer({to:n.unix(this._editEnd).toDate(),format:"",onTick:t.bind(this._onTick,this),onEnd:t.bind(this._onEnd,this)})}})}),define("views/postingAction",["jquery","underscore","marionette","models/app","views/postingActionBookmark","views/postingActionSolves","views/editCountdown"],function(e,t,i,n,o,s,r){"use strict";var a=i.ItemView.extend({events:{"click .js-btn-setAnsweringForm":"onBtnAnswer"},_jsButtons:[o,s],initialize:function(){this._initFormElements(),this.listenTo(this.model,"change:isAnsweringFormShown",this._toggleAnsweringForm)},_initFormElements:function(){t.each(this._jsButtons,function(e){this.$el.append(new e({model:this.model}).$el)},this);var e=this.$(".js-btn-edit");if(e.length>0){new r({el:e,model:this.model,editPeriod:n.settings.get("editPeriod")})}},onBtnAnswer:function(e){e.preventDefault(),this.model.set("isAnsweringFormShown",!0)},_toggleAnsweringForm:function(){this.model.get("isAnsweringFormShown")?this.$el.slideUp("fast"):this.$el.slideDown("fast")}});return a}),define("models/geshi",["underscore","backbone"],function(e,t){"use strict";var i=t.Model.extend({defaults:{isPlaintext:!1}});return i}),define("collections/geshis",["underscore","backbone","models/geshi"],function(e,t,i){var n=t.Collection.extend({model:i});return n}),define("views/geshi",["jquery","underscore","backbone","models/geshi"],function(e,t,i,n){"use strict";var o=i.View.extend({plainText:!1,htmlText:!1,events:{"click .geshi-plain-text":"_togglePlaintext"},initialize:function(){this.model=new n,this.collection.push(this.model),this.block=this.$(".geshi-plain-text").next(),this._setPlaintextButton(),this.listenTo(this.model,"change",this.render)},_setPlaintextButton:function(e){var t;e&&e.preventDefault(),t=this.model.get("isPlaintext")?"fa-list-ol":"fa-align-justify",this.$(".geshi-plain-text").html("<i class='fa "+t+"'></i>")},_togglePlaintext:function(e){e.preventDefault(),this.model.set("isPlaintext",!this.model.get("isPlaintext"))},_extractPlaintext:function(){this.plainText===!1&&(this.htmlText=this.block.html(),"Microsoft Internet Explorer"===navigator.appName?(this.htmlText=this.htmlText.replace(/\n\r/g,"+"),this.plainText=e(this.htmlText).text().replace(/\+\+/g,"\r")):this.plainText=this.block.text().replace(/code /g,"code \n"))},_renderText:function(){this.model.get("isPlaintext")?this.block.text(this.plainText).wrapInner('<pre class="code"></pre>'):this.block.html(this.htmlText)},render:function(){return this._setPlaintextButton(),this._extractPlaintext(),this._renderText(),this}});return o}),define("views/postingContent",["jquery","underscore","marionette","collections/geshis","views/geshi"],function(e,t,i,n,o){"use strict";return i.ItemView.extend({initialize:function(){this.listenTo(this.model,"change:isAnsweringFormShown",this._toggleAnsweringForm),this.listenTo(this.model,"change:html",this.render),this._initGeshi(".geshi-wrapper")},_toggleAnsweringForm:function(){this.model.get("isAnsweringFormShown")?this._hideSignature():this._showSignature()},_showSignature:function(){this.$(".postingBody-signature").slideDown("fast")},_hideSignature:function(){this.$(".postingBody-signature").slideUp("fast")},_initGeshi:function(e){var t=this.$(e);if(t.length>0){var i=new n;t.each(function(e,t){new o({el:t,collection:i})})}},render:function(){return this.$el.html(this.model.get("html")),this._initGeshi(".geshi-wrapper"),this}})}),define("models/upload",["underscore","backbone","models/app","cakeRest"],function(e,t,i,n){"use strict";var o=t.Model.extend({initialize:function(){this.webroot=i.settings.get("webroot")+"uploads/"}});return e.extend(o.prototype,n),o}),define("collections/uploads",["underscore","backbone","models/upload"],function(e,t,i){var n=t.Collection.extend({model:i,initialize:function(e){this.url=e.url+"uploads/index/"}});return n}),define("text!templates/upload.html",[],function(){return'<div class="panel-content upload_box_header">\n    <%= linkImage %>\n</div>\n<div class="panel-footer panel-form upload_box_footer">\n    <button class="btn btn-submit">\n        <%- $.i18n.__(\'upload_btn_insert_into_posting\') %>\n    </button>\n    <div class="upload_box_delete">\n        <%= linkDelete %>\n    </div>\n</div>\n'}),function(e,t){"use strict";"function"==typeof define&&define.amd?define("lib/saito/jquery.insertAtCaret",["jquery"],function(e){return t(e)}):t(jQuery)}(this,function(e){"use strict";e.fn.insertAtCaret=function(e){var t,i=this[0],n=0,o=i.selectionStart||"0"===i.selectionStart?"standard":document.selection?"ie":!1;"ie"===o?(i.focus(),t=document.selection.createRange(),t.moveStart("character",-i.value.length),n=t.text.length):"standard"===o&&(n=i.selectionStart);var s=i.value.substring(0,n),r=i.value.substring(n,i.value.length);return i.value=s+e+r,n+=e.length,"ie"===o?(i.focus(),t=document.selection.createRange(),t.moveStart("character",-i.value.length),t.moveStart("character",n),t.moveEnd("character",0),t.select()):"standard"===o&&(i.selectionStart=n,i.selectionEnd=n,i.focus()),this}}),define("views/upload",["jquery","underscore","backbone","models/app","text!templates/upload.html","lib/saito/jquery.insertAtCaret"],function(e,t,i,n,o){"use strict";var s=i.View.extend({className:"panel-content upload_box current",events:{"click .upload_box_delete":"_removeUpload","click .btn-submit":"_insert"},initialize:function(e){this.textarea=e.textarea,this.listenTo(this.model,"destroy",this._uploadRemoved)},_removeUpload:function(e){e.preventDefault(),this.model.destroy({success:t.bind(function(e,t){n.eventBus.trigger("notification",t)},this)})},_uploadRemoved:function(){this.remove()},_insert:function(t){t.preventDefault(),e(this.textarea).insertAtCaret("[upload]"+this.model.get("name")+"[/upload]")},render:function(){return this.$el.html(t.template(o,this.model.toJSON())),this}});return s}),function(e){function t(){}jQuery.event.props.push("dataTransfer");var i,n,o={fallback_id:"",url:"",refresh:1e3,paramname:"userfile",allowedfiletypes:[],maxfiles:25,maxfilesize:1,queuefiles:0,queuewait:200,data:{},headers:{},drop:t,dragStart:t,dragEnter:t,dragOver:t,dragLeave:t,docEnter:t,docOver:t,docLeave:t,beforeEach:t,afterAll:t,rename:t,error:function(e){alert(e)},uploadStarted:t,uploadFinished:t,progressUpdated:t,globalProgressUpdated:t,speedUpdated:t},s=["BrowserNotSupported","TooManyFiles","FileTooLarge","FileTypeNotAllowed","NotFound","NotReadable","AbortError","ReadError"],r=!1,a=0;e.fn.filedrop=function(t){function l(e){return T.drop.call(this,e)===!1?!1:(n=e.dataTransfer.files,null===n||void 0===n||0===n.length?(T.error(s[0]),!1):(a=n.length,h(),e.preventDefault(),!1))}function d(t,i,n,o){var s="--",r="\r\n",a="";if(T.data){var l=e.param(T.data).replace(/\+/g,"%20").split(/&/);e.each(l,function(){var e=this.split("=",2),t=decodeURIComponent(e[0]),i=decodeURIComponent(e[1]);a+=s,a+=o,a+=r,a+='Content-Disposition: form-data; name="'+t+'"',a+=r,a+=r,a+=i,a+=r})}return a+=s,a+=o,a+=r,a+='Content-Disposition: form-data; name="'+T.paramname+'"',a+='; filename="'+t+'"',a+=r,a+="Content-Type: "+n,a+=r,a+=r,a+=i,a+=r,a+=s,a+=o,a+=s,a+=r}function c(e){if(e.lengthComputable){var t=Math.round(100*e.loaded/e.total);if(this.currentProgress!==t){this.currentProgress=t,T.progressUpdated(this.index,this.file,this.currentProgress),S[this.global_progress_index]=this.currentProgress,u();var i=(new Date).getTime(),n=i-this.currentStart;if(n>=T.refresh){var o=e.loaded-this.startData,s=o/n;T.speedUpdated(this.index,this.file,s),this.startData=e.loaded,this.currentStart=i}}}}function u(){if(0!==S.length){var e,t=0;for(e in S)S.hasOwnProperty(e)&&(t+=S[e]);T.globalProgressUpdated(Math.round(t/S.length))}}function h(){if(r=!1,!n)return T.error(s[0]),!1;if(T.allowedfiletypes.push&&T.allowedfiletypes.length)for(var t=n.length;t--;)if(!n[t].type||e.inArray(n[t].type,T.allowedfiletypes)<0)return T.error(s[3],n[t]),!1;var i=0,o=0;if(a>T.maxfiles&&0===T.queuefiles)return T.error(s[1]),!1;for(var l=[],h=[],b=[],v=0;a>v;v++)l.push(v);var _=function(e){setTimeout(w,e)},w=function(){var e;if(r)return!1;if(T.queuefiles>0&&h.length>=T.queuefiles)return _(T.queuewait);e=l[0],l.splice(0,1),h.push(e);try{if(m(n[e])!==!1){if(e===a)return;var t=new FileReader,i=1048576*T.maxfilesize;if(t.index=e,n[e].size>i)return T.error(s[2],n[e],e),h.forEach(function(t,i){t===e&&h.splice(i,1)}),o++,!0;t.onerror=function(e){switch(e.target.error.code){case e.target.error.NOT_FOUND_ERR:return T.error(s[4]),!1;case e.target.error.NOT_READABLE_ERR:return T.error(s[5]),!1;case e.target.error.ABORT_ERR:return T.error(s[6]),!1;default:return T.error(s[7]),!1}},t.onloadend=T.beforeSend?function(t){T.beforeSend(n[e],e,function(){y(t)})}:y,t.readAsBinaryString(n[e])}else o++}catch(d){return h.forEach(function(t,i){t===e&&h.splice(i,1)}),T.error(s[0]),!1}l.length>0&&w()},y=function(t){var s=("undefined"==typeof t.srcElement?t.target:t.srcElement).index;void 0===t.target.index&&(t.target.index=p(t.total));var l,m=new XMLHttpRequest,v=m.upload,_=n[t.target.index],w=t.target.index,y=(new Date).getTime(),x="------multipartformboundary"+(new Date).getTime(),k=S.length,$=f(_.name),I=_.type;T.withCredentials&&(m.withCredentials=T.withCredentials),l="string"==typeof $?d($,t.target.result,I,x):d(_.name,t.target.result,I,x),v.index=w,v.file=_,v.downloadStartTime=y,v.currentStart=y,v.currentProgress=0,v.global_progress_index=k,v.startData=0,v.addEventListener("progress",c,!1),jQuery.isFunction(T.url)?m.open("POST",T.url(),!0):m.open("POST",T.url,!0),m.setRequestHeader("content-type","multipart/form-data; boundary="+x),e.each(T.headers,function(e,t){m.setRequestHeader(e,t)}),m.sendAsBinary(l),S[k]=0,u(),T.uploadStarted(w,_,a),m.onload=function(){var e=null;if(m.responseText)try{e=jQuery.parseJSON(m.responseText)}catch(t){e=m.responseText}var n=(new Date).getTime(),l=n-y,d=T.uploadFinished(w,_,e,l,m);i++,h.forEach(function(e,t){e===s&&h.splice(t,1)}),b.push(s),S[k]=100,u(),i===a-o&&g(),d===!1&&(r=!0),(m.status<200||m.status>299)&&T.error(m.statusText,_,s,m.status)}};w()}function p(e){for(var t=0;a>t;t++)if(n[t].size===e)return t;return void 0}function f(e){return T.rename(e)}function m(e){return T.beforeEach(e)}function g(){return T.afterAll()}function b(e){clearTimeout(i),e.preventDefault(),T.dragEnter.call(this,e)}function v(e){clearTimeout(i),e.preventDefault(),T.docOver.call(this,e),T.dragOver.call(this,e)}function _(e){clearTimeout(i),T.dragLeave.call(this,e),e.stopPropagation()}function w(e){return e.preventDefault(),T.docLeave.call(this,e),!1}function y(e){return clearTimeout(i),e.preventDefault(),T.docEnter.call(this,e),!1}function x(e){return clearTimeout(i),e.preventDefault(),T.docOver.call(this,e),!1}function k(e){i=setTimeout(function(t){return function(){T.docLeave.call(t,e)}}(this),200)}var T=e.extend({},o,t),S=[];return this.on("drop",l).on("dragstart",T.dragStart).on("dragenter",b).on("dragover",v).on("dragleave",_),e(document).on("drop",w).on("dragenter",y).on("dragover",x).on("dragleave",k),e("#"+T.fallback_id).change(function(e){T.drop(e),n=e.target.files,a=n.length,h()}),this};try{if(XMLHttpRequest.prototype.sendAsBinary)return;XMLHttpRequest.prototype.sendAsBinary=function(e){function t(e){return 255&e.charCodeAt(0)}var i=Array.prototype.map.call(e,t),n=new Uint8Array(i);this.send(n.buffer)}}catch(l){}}(jQuery),define("views/../../dev/vendors/jquery-filedrop/jquery.filedrop",function(){}),define("text!templates/uploadNew.html",[],function(){return'<form action="<%= url %>" method="post" class="dropbox" target="uploadIFrame"\n      enctype="multipart/form-data">\n    <div class="panel-content upload_box_header">\n        <div class="upload-layer">\n        </div>\n        <div class="upload-drag-indicator">\n            <i class="icon-upload"></i>\n        </div>\n        <h2> <%- $.i18n.__(\'upload_new_title\') %></h2>\n        <p>\n            <%- $.i18n.__(\'upload_info\', {size: upload_size}) %>\n        </p>\n    </div>\n    <div class="panel-footer panel-form upload_box_footer">\n        <div style="position: relative;">\n            <%\n            // To present a nice upload button we generate a dead button.\n            // Beneath the nice dummy button is the actual input file upload,\n            // but it\'s hidden behind the opacity:0 curtain div.\n            // z-index: 2000 to have the button above the jQuery UI modal.\n            %>\n            <button class="btn btn-submit" type="button">\n                <%- $.i18n.__("upload_btn") %>\n            </button>\n            <div style="position: absolute; z-index: 2000; top:0; right: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; overflow: hidden; " >\n                <input id="Upload0File"\n                       class="btn btn-submit"\n                       type="file" name="data[Upload][0][file]"\n                       style="width: 150px; height: 100%">\n            </div>\n        </div>\n    </div>\n</form>\n<iframe id="uploadIFrame" name="uploadIFrame" src="about:blank" style="display: none;">\n    <html><head></head><body></body></html>\n</iframe>\n'
}),define("text!templates/spinner.html",[],function(){return'<div class="spinner">\n    <div class="rect1"></div>\n    <div class="rect2"></div>\n    <div class="rect3"></div>\n    <div class="rect4"></div>\n    <div class="rect5"></div>\n</div>'}),define("views/uploadNew",["jquery","underscore","backbone","../../dev/vendors/jquery-filedrop/jquery.filedrop","models/app","text!templates/uploadNew.html","text!templates/spinner.html","humanize"],function(e,t,i,n,o,s,r,a){"use strict";var l=i.View.extend({className:"panel upload_box upload-new",wasChild:"unset",events:{"change #Upload0File":"_uploadManual"},initialize:function(e){this.uploadUrl=o.settings.get("webroot")+"uploads/add",this.collection=e.collection},_initDropUploader:function(){this._browserSupportsDragAndDrop()&&window.FileReader?this.$(".upload-layer").filedrop({maxfiles:1,maxfilesize:o.settings.get("upload_max_img_size")/1024,url:this.uploadUrl,paramname:"data[Upload][0][file]",allowedfiletypes:["image/jpeg","image/jpg","image/png","image/gif"],dragOver:t.bind(function(){this._showDragIndicator()},this),dragLeave:t.bind(function(){this._hideDragIndicator()},this),uploadFinished:t.bind(function(e,t,i){this._postUpload(i)},this),beforeSend:t.bind(function(e,t,i){this._hideDragIndicator(),this._setUploadSpinner(),i()},this),error:t.bind(function(t,i){var n;switch(this._hideDragIndicator(),t){case"FileTypeNotAllowed":n=e.i18n.__("upload_fileTypeNotAllowed");break;case"FileTooLarge":n=e.i18n.__("upload_fileToLarge",{name:i.name});break;case"BrowserNotSupported":n=e.i18n.__("upload_browserNotSupported");break;case"TooManyFiles":n=e.i18n.__("upload_toManyFiles");break;default:n=t}o.eventBus.trigger("notification",{title:"Error",message:n,type:"error"})},this)}):this.$("h2").html(e.i18n.__("Upload"))},_browserSupportsDragAndDrop:function(){var e=this.$(".upload-layer")[0];return"draggable"in e||"ondragstart"in e&&"ondrop"in e},_showDragIndicator:function(){this.$(".upload-drag-indicator").fadeIn()},_hideDragIndicator:function(){this.$(".upload-drag-indicator").fadeOut()},_setUploadSpinner:function(){this.$(".upload_box_header").html(r)},_uploadManual:function(e){var t,i,n=!0;e.preventDefault();try{t=new FormData,i=this.$("#Upload0File")[0],t.append(i.name,i.files[0])}catch(o){n=!1}this._setUploadSpinner(),n?this._uploadAjax(t):this._uploadIFrame()},_uploadIFrame:function(){var e=this.$("form"),i=this.$("#uploadIFrame");i.load(t.bind(function(){this._postUpload(i.contents().find("body").html()),i.off("load")},this)),e.submit()},_uploadAjax:function(e){var i=new XMLHttpRequest;i.open("POST",this.uploadUrl),i.onloadend=t.bind(function(e){this._postUpload(e.target.response)},this),i.onerror=this._onUploadError,i.send(e)},_onUploadError:function(){o.eventBus.trigger("notification",{type:"error",message:e.i18n.__("upload_genericError")})},_postUpload:function(e){if(t.isString(e))try{e=JSON.parse(e)}catch(i){this._onUploadError()}o.eventBus.trigger("notification",e),this.collection.fetch({reset:!0}),this.render()},render:function(){return this.$el.html(t.template(s)({url:this.uploadUrl,upload_size:a.filesize(o.settings.get("upload_max_img_size"))})),this._initDropUploader(),this}});return l}),define("text!templates/uploads.html",[],function(){return'<div id="upload_index" class="upload index">\n    <div class="content">\n    </div>\n</div>\n'}),define("views/uploads",["jquery","underscore","backbone","models/app","collections/uploads","views/upload","views/uploadNew","text!templates/uploads.html"],function(e,t,i,n,o,s,r,a){var l=i.View.extend({events:{"click .current .btn-submit":"_closeDialog"},initialize:function(e){this.textarea=e.textarea,this.collection=new o({url:n.settings.get("webroot")}),this.listenTo(this.collection,"reset",this._addAll),this.$(".body").html(t.template(a)),this.uploadNewView=new r({collection:this.collection}),this.$(".content").append(this.uploadNewView.el),this.render(),this.collection.fetch({reset:!0})},_addOne:function(e){var t=new s({model:e,textarea:this.textarea});this.$(".upload-new").after(t.render().el)},_addAll:function(){this._removeAll(),this.collection.each(this._addOne,this)},_removeAll:function(){this.$(".upload_box.current").remove()},_setDialogSize:function(){this.$el.dialog("option","width",window.innerWidth-80),this.$el.dialog("option","height",window.innerHeight-80)},_closeDialog:function(){this.$el.dialog("close")},render:function(){return this.uploadNewView.render(),this.$el.dialog({title:e.i18n.__("Upload"),modal:!0,draggable:!1,resizable:!1,position:[40,40],hide:"fade"}),this._setDialogSize(),e(window).resize(t.bind(function(){this._setDialogSize()},this)),window.onorientationchange=t.bind(function(){this._setDialogSize()},this),this}});return l}),define("lib/saito/markItUp.media",["jquery","underscore"],function(e,t){"use strict";var i={_preFilters:{dropbox:{cleanUp:function(e){return e.replace(/https:\/\/www\.dropbox\.com\//,"https://dl.dropbox.com/")}},youtube:{cleanUp:function(e){var t,i,n,o=e;if(/http/.test(e)===!1&&(o="http://"+e),i=/(http|https):\/\/(\w+:?\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/i,!i.test(o))return e;switch(t=o.match(/(https?:\/\/)?(www\.)?(.[^\/:]+)/i).pop()){case"youtu.be":i=/youtu.be\/(.*?)(&.*)?$/,i.test(o)&&(n=o.match(i)[1]);break;case"youtube.com":i=/v=(.*?)(&.*)?$/,i.test(o)&&(n=o.match(i)[1])}return void 0!==n&&(e=this._createIframe({src:"//www.youtube.com/embed/"+n})),e},_createIframe:function(e){var i,n,o;return i={width:560,height:315,frameborder:0,allowfullscreen:"allowfullscreen"},t.defaults(e,i),o=function(e,t,i){return e+i+'="'+t+'" '},n=t.reduce(e,o,""),n=n.trim(),"<iframe "+n+"></iframe>"}}},multimedia:function(n,o){var s=e.trim(n),r="([\\/?]|$)",a=new RegExp("\\.(png|gif|jpg|jpeg|webp)"+r,"i"),l=new RegExp("\\.(mp4|webm|m4v)"+r,"i"),d=new RegExp("\\.(m4a|ogg|mp3|wav|opus)"+r,"i"),c=/<object/i,u=/<iframe/i,h="";return o=o||{},t.defaults(o,{embedlyEnabled:!1}),t.each(this._preFilters,function(e){s=e.cleanUp(s)}),a.test(s)?h=i._image(s):l.test(s)?h=i._videoHtml5(s):d.test(s)?h=i._audioHtml5(s):u.test(s)?h=i._videoIframe(s):c.test(s)&&(h=i._videoFlash(s)),o.embedlyEnabled===!0&&""===h&&(h=i._embedly(s)),h},_image:function(e){return"[img]"+e+"[/img]"},_videoFlash:function(e){var t="[flash_video]URL|WIDTH|HEIGHT[/flash_video]";return null!==e?(t=t.replace("WIDTH",/width="(\d+)"/.exec(e)[1]),t=t.replace("HEIGHT",/height="(\d+)"/.exec(e)[1]),t=t.replace("URL",/src="([^"]+)"/.exec(e)[1])):""},_videoHtml5:function(e){return"[video]"+e+"[/video]"},_audioHtml5:function(e){return"[audio]"+e+"[/audio]"},_videoIframe:function(e){var t=/<iframe(.*?)>.*?<\/iframe>/i.exec(e)[1];return t=t.replace(/["']/g,""),"[iframe"+t+"][/iframe]"},_embedly:function(e){return"[embed]"+e+"[/embed]"}};return i}),define("text!templates/mediaInsert.html",[],function(){return'<div class="panel">\n    <div class="panel-content panel-form">\n        <form action="#" style="width: 100%;">\n            <label for="markitup_media_txta">\n                <%- $.i18n.__(\'Enter link to media or embedding code:\') %>\n            </label>\n            <textarea name="data[media]" id="markitup_media_txta" rows="6"\n                      columns="20"></textarea>\n            <input class="btn btn-submit" id="markitup_media_btn" type="submit"\n                   value="<%- $.i18n.__(\'Insert\') %>">\n\n            <div id="markitup_media_message" class="flash error"\n                 style="display: none;">\n                <%- $.i18n.__(\'Nothing recognized.\') %>\n            </div>\n        </form>\n    </div>\n</div>\n'}),define("views/mediaInsert",["jquery","underscore","backbone","models/app","lib/saito/markItUp.media","text!templates/mediaInsert.html"],function(e,t,i,n,o,s){"use strict";return i.View.extend({template:t.template(s),events:{"click #markitup_media_btn":"_insert"},initialize:function(){void 0!==this.model&&null!==this.model&&this.listenTo(this.model,"change:isAnsweringFormShown",this.remove)},_insert:function(t){var i,s;t.preventDefault(),s=o,i=s.multimedia(this.$("#markitup_media_txta").val(),{embedlyEnabled:n.settings.get("embedly_enabled")===!0}),""===i?this._invalidInput():(e.markItUp({replaceWith:i}),this._closeDialog())},_hideErrorMessages:function(){this.$("#markitup_media_message").hide()},_invalidInput:function(){this.$("#markitup_media_message").show(),this.$el.dialog().parent().effect("shake",{times:2},250)},_closeDialog:function(){this.$el.dialog("close"),this._hideErrorMessages(),this.$("#markitup_media_txta").val("")},_showDialog:function(){this.$el.dialog({show:{effect:"scale",duration:200},hide:{effect:"fade",duration:200},title:e.i18n.__("Multimedia"),minWidth:346,position:{at:"left+50% top+40%"},resizable:!1,open:function(){setTimeout(function(){e("#markitup_media_txta").focus()},210)},close:t.bind(function(){this._hideErrorMessages()},this)})},render:function(){return this.$el.html(this.template),this._showDialog(),this}})}),define("models/preview",["underscore","backbone","models/app"],function(e,t,i){"use strict";var n=t.Model.extend({defaults:{isFetchingData:!1,rendered:null,data:null},initialize:function(){this.webroot=i.settings.get("webroot"),this.listenTo(this,"change:data",this._fetchRendered)},_fetchRendered:function(){this.set("fetchingData",!0),$.post(this.webroot+"entries/preview/",this.get("data"),e.bind(function(e){this.set("fetchingData",!1),this.set("rendered",e.html),i.eventBus.trigger("notificationUnset","all"),i.eventBus.trigger("notification",e)},this),"json")}});return n}),define("views/preview",["jquery","underscore","marionette","text!templates/spinner.html"],function(e,t,i,n){"use strict";var o=i.ItemView.extend({templates:{content:t.template("<%= rendered %>"),spinner:t.template(n)},modelEvents:{"change:fetchingData":"_fetchingData","change:rendered":"render"},_fetchingData:function(){this.model.get("fetchingData")&&this.render()},getTemplate:function(){return this.model.get("fetchingData")?this.templates.spinner:this.templates.content}});return o}),function(e){"use strict";var t={_scrollToTop:function(t){e("body").animate({scrollTop:t.offset().top-10,easing:"swing"},300)},_scrollToBottom:function(i){e("body").animate({scrollTop:t._elementBottom(i)-e(window).height()+20,easing:"swing"},300,function(){t._isHeigherThanView(i)&&t._scrollToTop(i)})},_elementBottom:function(e){return e.offset().top+e.height()},_isScrolledIntoView:function(i){if(0===e(i).length)return!0;var n=e(window).scrollTop(),o=n+e(window).height(),s=e(i).offset().top,r=t._elementBottom(i);return o>=r&&s>=n},_isHeigherThanView:function(t){return e(window).height()<=t.height()}},i={top:function(){var i;return i=e(this),t._isScrolledIntoView(i)||t._scrollToTop(i),this},bottom:function(){var i;return i=e(this),t._isScrolledIntoView(i)||t._scrollToBottom(i),this},isInView:function(){var i;return i=e(this),t._isScrolledIntoView(i)}};e.fn.scrollIntoView=function(t){return i[t]?i[t].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof t&&t?void e.error("Method "+t+" does not exist on jQuery.scrollIntoView"):i.init.apply(this,arguments)}}(jQuery),define("lib/saito/jquery.scrollIntoView",function(){}),define("views/answering",["jquery","underscore","backbone","models/app","views/uploads","views/mediaInsert","views/editCountdown","models/preview","views/preview","lib/saito/jquery.scrollIntoView","jqueryAutosize"],function(e,t,i,n,o,s,r,a,l){"use strict";var d=i.View.extend({_requestUrl:null,rendered:!1,answeringForm:!1,preview:!1,mediaView:!1,sendInProgress:!1,_action:null,model:null,events:{"click .btn-previewClose":"_closePreview","click .btn-preview":"_showPreview","click .btn-markItUp-Upload":"_upload","click .btn-markItUp-Media":"_media","click .btn-submit":"_send","click .btn-cite":"_cite","keypress .js-subject":"_onKeyPressSubject","input .js-subject":"_updateSubjectCharCount"},initialize:function(e){this.parentThreadline=e.parentThreadline||null,this._setupTextArea(),this.parentThreadline||this._onFormReady(),this._requestUrl=n.settings.get("webroot")+"entries/add/"+this.model.get("id"),this.listenTo(n.eventBus,"isAppVisible",this._focusSubject)},_disable:function(){this.$(".btn.btn-submit").attr("disabled","disabled")},_enable:function(){this.$(".btn.btn-submit").removeAttr("disabled")},_cite:function(e){e.preventDefault();var t=this.$(".cite-container"),i=this.$(".btn-cite").data("text"),n=this.$textarea.val();this.$textarea.val(i+"\n\n"+n),t.slideToggle(),this.$textarea.trigger("autosize.resize"),this.$textarea.focus()},_onKeyPressSubject:function(e){13===e.keyCode&&this._send(e)},_updateSubjectCharCount:function(){var e,t,i;e=this.$(".postingform-subject-count"),t=n.settings.get("subject_maxlength"),i=this.$(".js-subject").val(),e.html(t-i.length)},_upload:function(e){var t;e&&e.preventDefault(),t=new o({el:"#markitup_upload",textarea:this.$textarea[0]})},_media:function(e){e.preventDefault(),this.mediaView===!1&&(this.mediaView=new s({el:"#markitup_media",model:this.model})),this.mediaView.render()},_showPreview:function(e){var t;e.preventDefault(),this.$(".preview").slideDown("fast"),this.preview===!1&&(t=new a,this.preview=new l({el:this.$(".preview .panel-content"),model:t})),this.preview.model.set("data",this.$("form").serialize())},_closePreview:function(e){e.preventDefault(),this.$(".preview").slideUp("fast")},_setupTextArea:function(){this.$textarea=this.$("textarea#EntryText"),this.$textarea.autosize()},_requestAnsweringForm:function(){e.ajax({cache:!0,url:this._requestUrl,success:t.bind(function(e){this.answeringForm=e,this.render()},this)})},_postRendering:function(){this.$el.scrollIntoView("bottom"),this._focusSubject(),this._onFormReady()},_onFormReady:function(){this._setupTextArea(),this._updateSubjectCharCount();var e=this.$(".js-data");if(e.length>0&&"edit"===e.data("meta").action){var t=this.$(".js-data").data("entry");this.model.set(t,{silent:!0}),this._addCountdown()}n.eventBus.trigger("change:DOM")},_addCountdown:function(){{var e=this.$(".js-btn-submit");new r({el:e,model:this.model,editPeriod:n.settings.get("editPeriod"),done:"disable"})}},_focusSubject:function(){var e=window.navigator.userAgent.match("iPad|iPhone");e||this.$(".postingform input[type=text]:first").focus()},_send:function(e){return this.sendInProgress?void e.preventDefault():(this.sendInProgress=!0,void(this.parentThreadline?this._sendInline(e):this._sendRedirect(e)))},_sendRedirect:function(i){var n=this.$(".btn-submit")[0];if(i.preventDefault(),"object"==typeof n.validity&&n.form.checkValidity()===!1){var o=t.bind(function(){this.checkValidityDummy||(this.checkValidityDummy=e("<button></button>",{type:"submit",style:"display: none;"}),e(n).after(this.checkValidityDummy)),this.checkValidityDummy.click()},this);o(),this.sendInProgress=!1}else n.disabled=!0,n.form.submit()},_sendInline:function(i){i.preventDefault();var o=this.$("#EntryAddForm").serialize(),s=t.bind(function(e){this.model.set({isAnsweringFormShown:!1}),null!==this.parentThreadline&&this.parentThreadline.set("isInlineOpened",!1),n.eventBus.trigger("newEntry",{tid:e.tid,pid:this.model.get("id"),id:e.id,isNewToUser:!0})},this),r=t.bind(function(e,t){this.sendInProgress=!1,this._enable(),n.eventBus.trigger("notification",{title:t,type:"error",message:e.responseText})},this),a=t.bind(this._disable,this);e.ajax({url:this._requestUrl,type:"POST",dataType:"json",data:o,beforeSend:a}).done(s).fail(r)},render:function(){return this.answeringForm===!1?this._requestAnsweringForm():this.rendered===!1?(this.rendered=!0,this.$el.html(this.answeringForm),t.defer(function(e){e._postRendering()},this)):n.eventBus.trigger("change:DOM"),this}});return d}),define("views/postingSlider",["jquery","marionette","models/app","views/answering","text!templates/spinner.html"],function(e,t,i,n,o){"use strict";return t.ItemView.extend({answeringForm:!1,events:{"click .btn-answeringClose":"onBtnClose"},initialize:function(e){this.parentThreadline=e.parentThreadline||null,this.listenTo(this.model,"change:isAnsweringFormShown",this.toggleAnsweringForm)},onBtnClose:function(e){e.preventDefault(),this.model.set("isAnsweringFormShown",!1)},toggleAnsweringForm:function(){this.model.get("isAnsweringFormShown")?(this._hideAllAnsweringForms(),this._showAnsweringForm()):this._hideAnsweringForm()},_showAnsweringForm:function(){i.eventBus.trigger("breakAutoreload"),this.answeringForm===!1&&this.$el.html(o),this.$el.slideDown("fast"),this.answeringForm===!1&&(this.answeringForm=new n({el:this.$el,model:this.model,parentThreadline:this.parentThreadline})),this.answeringForm.render()},_hideAnsweringForm:function(){this.$el.slideUp("fast",function(){i.eventBus.trigger("change:DOM")})},_hideAllAnsweringForms:function(){this.collection.forEach(function(e){e.get("id")!==this.model.get("id")&&e.set("isAnsweringFormShown",!1)},this)}})}),define("views/postingLayout",["underscore","marionette","app/core","views/postingAction","views/postingContent","views/postingSlider","text!templates/spinner.html"],function(e,t,i,n,o,s,r){"use strict";var a=t.Layout.extend({initialize:function(t){e.defaults(t,{inline:!1,parentThreadline:!1}),t.inline?this._loadData(t):this._dataReady(t)},_loadData:function(t){this.$el.html(r),this.model.fetchHtml({success:e.bind(function(){this.$el.html(this.model.get("html")),this._dataReady(t)},this)})},_dataReady:function(e){var t=this.$(".js-data").data("entry");this.model.set(t,{silent:!0});new o({el:this.$(".postingBody"),model:this.model}),new n({el:this.$(".postingLayout-actions"),model:this.model}),new s({el:this.$(".postingLayout-slider"),model:this.model,collection:this.collection,parentThreadline:e.parentThreadline});i.vent.trigger("Vent.Posting.View.afterRender",{$el:this.$el})}});return a}),function(e,t){"use strict";"function"==typeof define&&define.amd?define("lib/saito/backbone.modelHelper",["underscore","backbone"],function(i,n){return t(i||e._,n||e.Backbone)}):t(_,Backbone)}(this,function(e,t){"use strict";t.Model.prototype.toggle=function(e){this.set(e,!this.get(e))}}),define("models/posting",["underscore","backbone","models/app","lib/saito/backbone.modelHelper"],function(e,t,i){"use strict";var n=t.Model.extend({defaults:{isBookmarked:!1,isSolves:!1,isAnsweringFormShown:!1,html:""},initialize:function(){this.listenTo(this,"change:isSolves",this.syncSolved),this.listenTo(this,"change:isBookmarked",this.syncBookmarked)},isRoot:function(){var t=this.get("pid");if(!e.isNumber(t))throw"pid is not a number.";return 0===t},syncBookmarked:function(){this.get("isBookmarked")&&$.ajax({url:i.settings.get("webroot")+"bookmarks/add",type:"POST",dataType:"json",data:"id="+this.get("id")})},syncSolved:function(){$.ajax({url:i.settings.get("webroot")+"entries/solve/"+this.get("id"),type:"POST",dateType:"json"})},fetchHtml:function(t){$.ajax({success:e.bind(function(e){this.set("html",e),t&&t.success&&t.success()},this),type:"POST",dateType:"html",url:i.settings.get("webroot")+"entries/view/"+this.get("id")})}});return n}),define("views/threadlines",["jquery","underscore","marionette","models/app","models/threadline","text!templates/threadline-spinner.html","views/postingLayout","models/posting","lib/saito/jquery.scrollIntoView"],function(e,t,i,n,o,s,r,a){"use strict";var l=i.ItemView.extend({className:"threadLeaf",tagName:"li",spinnerTpl:s,postings:null,ui:{btnShowThread:".btn_show_thread",linkShowThread:".link_show_thread"},events:{"click @ui.btnShowThread":"toggleInlineOpen","click @ui.linkShowThread":"toggleInlineOpenFromLink"},initialize:function(e){this.postings=e.postings,this.model=new o({id:e.leafData.id,isNewToUser:e.leafData.isNewToUser}),void 0===e.el?this.model.fetch():this.model.set({html:this.el}),this.collection.add(this.model,{silent:!0}),this.attributes={"data-id":e.id},this.listenTo(this.model,"change:isInlineOpened",this._toggleInlineOpened),this.listenTo(this.model,"change:html",this.render)},toggleInlineOpenFromLink:function(e){this.model.get("isAlwaysShownInline")&&this.toggleInlineOpen(e)},toggleInlineOpen:function(e){e.preventDefault(),this.model.toggle("isInlineOpened")},_toggleInlineOpened:function(e,i){return i?(this.model.get("isContentLoaded")||(this.$(".threadLine").after(this.spinnerTpl),this.$(".js-btn-strip").on("click",t.bind(this.toggleInlineOpen,this)),this._insertContent(),this.model.set("isContentLoaded",!0)),void this._showInlineView()):void this._closeInlineView()},_insertContent:function(){var e,t;e=this.model.get("id"),this.postingModel=new a({id:e}),this.postings.add(this.postingModel),t=new r({el:this.$(".threadInline-slider"),inline:!0,model:this.postingModel,collection:this.postings,parentThreadline:this.model})},_showInlineView:function(){var e=t.bind(function(){var e=this.model.get("shouldScrollOnInlineOpen");e?this.$el.scrollIntoView("isInView")===!1&&this.$el.scrollIntoView("bottom"):this.model.set("shouldScrollOnInlineOpen",!0)},this);this.$(".threadLine").fadeOut(100,t.bind(function(){this.$(".js-thread_inline").show(0,e)},this))},_closeInlineView:function(){n.eventBus.trigger("change:DOM"),this.$(".js-thread_inline").hide(0,t.bind(function(){this.$el.find(".threadLine").slideDown(),this._scrollLineIntoView()},this))},_scrollLineIntoView:function(){var e=this.$(".threadLine");e.scrollIntoView("isInView")||e.scrollIntoView("top").effect("highlight",{times:1},3e3)},render:function(){var t,i,n;return i=this.model.get("html"),i.length>0&&(t=this.$el,n=e(this.model.get("html")),this.setElement(n),t.replaceWith(n)),this}});return l}),define("models/thread",["underscore","backbone","collections/threadlines"],function(e,t,i){"use strict";var n=t.Model.extend({defaults:{isThreadCollapsed:!1},initialize:function(){this.threadlines=new i}});return n}),define("collections/threads",["underscore","backbone","models/thread","models/app","backboneLocalStorage","lib/saito/localStorageHelper"],function(e,t,i,n){"use strict";var o=t.Collection.extend({model:i,localStorage:function(){var e=n.reqres.request("app:localStorage:key","Threads");return new t.LocalStorage(e)}(),fetch:function(e){return n.reqres.request("app:localStorage:available")?t.Model.prototype.fetch.call(this,e):void 0}});return o}),define("views/thread",["jquery","underscore","backbone","models/app","collections/threadlines","views/threadlines"],function(e,t,i,n,o,s){"use strict";var r=i.View.extend({className:"threadBox",events:{"click .btn-threadCollapse":"collapseThread","click .js-btn-openAllThreadlines":"openAllThreadlines","click .js-btn-closeAllThreadlines":"closeAllThreadlines","click .js-btn-showAllNewThreadlines":"showAllNewThreadlines"},initialize:function(t){this.postings=t.postings,this.$rootUl=this.$("ul.root"),this.$subThreadRootIl=e(this.$rootUl.find("li:not(:first-child)")[0]),this.model.get("isThreadCollapsed")?this.hide():this.show(),n.reqres.request("app:localStorage:available")||this._hideCollapseButton(),this.listenTo(n.eventBus,"newEntry",this._showNewThreadLine),this.listenTo(this.model,"change:isThreadCollapsed",this.toggleCollapseThread)},_showNewThreadLine:function(e){var t;e.tid===this.model.get("id")&&(t=new s({leafData:e,collection:this.model.threadlines,postings:this.postings}),this._appendThreadlineToThread(e.pid,t.render().$el))},_appendThreadlineToThread:function(e,t){var i,n;i=this.$('.threadLeaf[data-id="'+e+'"]'),n=i.next().not(".js_threadline").find("ul:first"),0===n.length?t.wrap('<ul class="threadTree-node"></ul>').parent().wrap("<li></li>").parent().insertAfter(i):n.append(t)},openAllThreadlines:function(e){e.preventDefault(),t.each(this.model.threadlines.where({isInlineOpened:!1}),function(e){e.set({isInlineOpened:!0,shouldScrollOnInlineOpen:!1})},this)},closeAllThreadlines:function(e){e&&e.preventDefault(),t.each(this.model.threadlines.where({isInlineOpened:!0}),function(e){e.set({isInlineOpened:!1})},this)},showAllNewThreadlines:function(e){e.preventDefault(),t.each(this.model.threadlines.where({isInlineOpened:!1,isNewToUser:!0}),function(e){e.set({isInlineOpened:!0,shouldScrollOnInlineOpen:!1})},this)},_hideCollapseButton:function(){this.$(".btn-threadCollapse").css("visibility","hidden")},collapseThread:function(e){e.preventDefault(),this.closeAllThreadlines(),this.model.toggle("isThreadCollapsed"),this.model.save()},toggleCollapseThread:function(e,t){t?this.slideUp():this.slideDown()},slideUp:function(){this.$subThreadRootIl.slideUp(300),this.markHidden()},slideDown:function(){this.$subThreadRootIl.slideDown(300),this.markShown()},hide:function(){this.$subThreadRootIl.hide(),this.markHidden()},show:function(){this.$subThreadRootIl.show(),this.markShown()},markShown:function(){e(this.el).find(".fa-thread-closed").removeClass("fa-thread-closed").addClass("fa-thread-open")},markHidden:function(){e(this.el).find(".fa-thread-open").removeClass("fa-thread-open").addClass("fa-thread-closed")}});return r}),define("collections/postings",["underscore","backbone","models/posting"],function(e,t,i){var n=t.Collection.extend({model:i});return n}),define("models/bookmark",["underscore","backbone","models/app","cakeRest"],function(e,t,i,n){"use strict";var o=t.Model.extend({initialize:function(){this.webroot=i.settings.get("webroot")+"bookmarks/"}});return e.extend(o.prototype,n),o}),define("collections/bookmarks",["underscore","backbone","models/bookmark"],function(e,t,i){var n=t.Collection.extend({model:i});return n}),define("views/bookmark",["jquery","underscore","backbone"],function(e,t,i){"use strict";var n=i.View.extend({events:{"click .btn-bookmark-delete":"deleteBookmark"},initialize:function(){t.bindAll(this,"render"),this.model.on("destroy",this.removeBookmark,this)},deleteBookmark:function(e){e.preventDefault(),this.model.destroy()},removeBookmark:function(){var t=this.collection;this.$el.hide("slide",null,500,function(){e(this).remove(),t.trigger("bookmark.removed")})}});return n}),define("text!templates/no-content-yet.html",[],function(){return"<div class=\"no-content-yet\">\n	<%- $.i18n.__('ncy.bkm') %>\n</div>\n"}),define("views/bookmarks",["jquery","underscore","backbone","views/bookmark","text!templates/no-content-yet.html"],function(e,t,i,n,o){"use strict";var s=i.View.extend({initialize:function(){this.initCollectionFromDom(".js-bookmark",this.collection,n),this._fillNoContentYet(),this.listenTo(this.collection,"bookmark.removed",this._fillNoContentYet)},_fillNoContentYet:function(){this.collection.isEmpty()&&this.$el.html(t.template(o))}});return s}),define("views/helps",["jquery","underscore","backbone","models/app","drop"],function(e,t,i,n,o){"use strict";var s=i.View.extend({isHelpShown:!1,_popups:[],_elements:null,tpl:t.template('<a href="<%= webroot %>help/<%= id %>" target="_blank"><i class="fa fa-question-circle"></i></a>'),events:function(){var e={};return e["click "+this.indicatorName]="toggle",e},initialize:function(e){this.indicatorName=e.indicatorName,this.elementName=e.elementName,this.webroot=e.webroot,this.activateHelpButton(),this.listenTo(n.eventBus,"change:DOM",this._onDomChange)},activateHelpButton:function(){var t=e(this.indicatorName);t&&(this._isHelpOnPage()?t.addClass("is-active"):t.removeClass("is-active"))},_onDomChange:function(){this.activateHelpButton(),this._reset()},_isHelpOnPage:function(){return this._getElements().length>0},toggle:function(e){e.preventDefault(),this.isHelpShown?this._hide():this._show()},_reset:function(){this._hide(),this._elements=null,this._popups=[]},_getElements:function(){return null===this._elements&&(this._elements=this.$(this.elementName).filter(":visible")),this._elements},_show:function(){if(this.isHelpShown=!0,this._isHelpOnPage()){if(0===this._popups.length){var t=this;this._getElements().each(function(){var i=e(this),n=i.data("shpid"),s=t.tpl({id:n,webroot:t.webroot});t._popups.push(new o({target:this,content:s,classes:"drop-theme-arrows",position:"top center"}))})}this._popups.forEach(function(e){e.open()})}},_hide:function(){this.isHelpShown=!1,this._popups.forEach(function(e){e.close()})}});return s}),define("views/categoryChooser",["jquery","underscore","backbone"],function(e,t,i){"use strict";return i.View.extend({initialize:function(){this._initDialog()},_initDialog:function(){this.$el.dialog({autoOpen:!1,show:{effect:"scale",duration:200},hide:{effect:"fade",duration:200},width:400,title:e.i18n.__("Categories"),resizable:!1})},_updateDialogPosition:function(){var t=e("#btn-category-chooser"),i=e(window),n=t.offset().left+t.width()-i.scrollLeft()-410,o=t.offset().top-i.scrollTop()+t.height();this.$el.dialog({position:[n,o]})},toggle:function(){this.$el.dialog("isOpen")?this.$el.dialog("close"):(this._updateDialogPosition(),this.$el.dialog("open"))}})}),define("models/slidetab",["jquery","underscore","backbone","app/vent","models/app"],function(e,t,i,n,o){"use strict";var s=i.Model.extend({defaults:{isOpen:!1},initialize:function(){this.webroot=o.settings.get("webroot"),this.listenTo(this,"change:isOpen",this.onChangeIsOpen)},onChangeIsOpen:function(){n.vent.trigger("slidetab:open",{slidetab:this.get("id"),open:this.get("isOpen")})},sync:function(){var t="show_"+this.get("id");e.post(this.webroot+"users/slidetab_toggle",{slidetabKey:t})}});return s}),define("collections/slidetabs",["underscore","backbone","models/app","models/slidetab"],function(e,t,i,n){"use strict";var o=t.Collection.extend({model:n,initialize:function(){i.reqres.setHandler("slidetab:open",e.bind(this.isOpen,this))},isOpen:function(e){return this.get(e).get("isOpen")}});return o}),define("views/slidetab",["jquery","underscore","backbone"],function(e,t,i){"use strict";var n=i.View.extend({events:{"click .slidetab-tab":"clickSlidetab"},initialize:function(){this.model.set({isOpen:this.isOpen()},{silent:!0}),this.listenTo(this.model,"change",this.toggleSlidetab)},isOpen:function(){return this.$el.find(".slidetab-outer").is(":visible")},clickSlidetab:function(){this.model.save("isOpen",!this.model.get("isOpen"))},toggleSlidetab:function(){this.model.get("isOpen")?this.show():this.hide(),this.toggleSlidetabTabInfo()},show:function(){this.$el.animate({width:280}),this.$el.addClass("is-open")},hide:function(){this.$el.animate({width:28},t.bind(function(){this.$el.removeClass("is-open")},this))},toggleSlidetabTabInfo:function(){this.$el.find(".slidetab-tab-info").toggle()}});return n}),define("views/slidetabs",["jquery","underscore","backbone","models/app","views/slidetab"],function(e,t,i,n,o){"use strict";var s=i.View.extend({initialize:function(){this.webroot=n.settings.get("webroot"),this.initCollectionFromDom(".slidetab",this.collection,o),this.makeSortable()},makeSortable:function(){var i=this.webroot;this.$el.sortable({handle:".slidetab-tab",start:t.bind(function(){this.$el.css("overflow","visible")},this),stop:t.bind(function(){this.$el.css("overflow","hidden")},this),update:function(){var t=e(this).sortable("toArray",{attribute:"data-id"});t=t.map(function(e){return"slidetab_"+e}),e.post(i+"users/slidetab_order",{slidetabOrder:t})}})}});return s}),define("views/app",["jquery","underscore","backbone","models/app","collections/threadlines","views/threadlines","collections/threads","views/thread","collections/postings","models/posting","views/postingLayout","collections/bookmarks","views/bookmarks","views/helps","views/categoryChooser","collections/slidetabs","views/slidetabs","views/answering","jqueryUi"],function(e,t,i,n,o,s,r,a,l,d,c,u,h,p,f,m,g,b){"use strict";var v=i.View.extend({el:e("body"),autoPageReloadTimer:!1,_domInitializers:{".entry.add-not-inline":"_initAnsweringNotInlined","#bookmarks":"_initBookmarks","#category-chooser":"_initCategoryChooser",".js-entry-view-core":"_initPostings","#slidetabs":"_initSlidetabs",".threadBox":"_initThreadBoxes",".threadLeaf":"_initThreadLeafs",".users.logout":"_initLogout"},events:{"click #showLoginForm":"showLoginForm","focus #header-searchField":"widenSearchField","click #btn-scrollToTop":"scrollToTop","click #btn-manuallyMarkAsRead":"manuallyMarkAsRead","click #btn-category-chooser":"toggleCategoryChooser","click #btn_header_logo":"_onEntriesIndexReload"},initialize:function(){this.threads=new r,"entries"===n.request.controller&&"index"===n.request.action&&this.threads.fetch(),this.postings=new l,this.threadLines=new o,this.listenTo(n.eventBus,"initAutoreload",this.initAutoreload),this.listenTo(n.eventBus,"breakAutoreload",this.breakAutoreload),this.$el.on("dialogopen",this.fixJqueryUiDialog)
},initFromDom:function(i){if(t.each(this._domInitializers,function(t,i){var n=e(i);n.length>0&&this[t](n)},this),this.initAutoreload(),this.initHelp(".shp"),n.status.start(),this._showPage(i.SaitoApp.timeAppStart,i.contentTimer),n.eventBus.trigger("notification",i.SaitoApp),window.location.href.indexOf("/jump:")>-1){var o=/jump:(\d+)/.exec(window.location.href);this.scrollToThread(o[1]),window.history.replaceState("object or string","Title",window.location.pathname.replace(/jump:\d+(\/)?/,""))}},_initAnsweringNotInlined:function(e){this.answeringForm=new b({el:e,model:new d({id:"foo"})})},_initBookmarks:function(e){var t,i=new u;t=new h({el:e,collection:i})},_initCategoryChooser:function(e){this.categoryChooser=new f({el:e})},_initLogout:function(){n.commands.execute("app:localStorage:clear")},_initPostings:function(i){t.each(i,function(t){var i,n,o;i=parseInt(t.getAttribute("data-id"),10),o=new d({id:i}),this.postings.add(o,{silent:!0}),n=new c({el:e(t),model:this.postings.get(i),collection:this.postings})},this)},_initSlidetabs:function(e){var t,i;t=new m,i=new g({el:e,collection:t})},_initThreadBoxes:function(i){t.each(i,function(t){var i,o;o=parseInt(e(t).attr("data-id"),10),this.threads.get(o)||this.threads.add([{id:o,isThreadCollapsed:"entries"===n.request.controller&&"index"===n.request.action&&n.currentUser.get("user_show_thread_collapsed")}],{silent:!0}),i=new a({el:e(t),postings:this.postings,model:this.threads.get(o)})},this)},_initThreadLeafs:function(i){t.each(i,function(t){var i=JSON.parse(t.getAttribute("data-leaf"));i.isNewToUser=i["new"],delete i["new"];var n,o=this.threads.get(i.tid);n=o?o.threadlines:this.threadLines;new s({el:e(t),leafData:i,postings:this.postings,collection:n})},this)},_showPage:function(t,i){var o=function(){n.eventBus.trigger("isAppVisible",!0)};n.request.isMobile||(new Date).getTime()-t>1500?(e("#content").css("visibility","visible"),o()):e("#content").css({visibility:"visible",opacity:0}).animate({opacity:1},{duration:150,easing:"easeInOutQuart",complete:o}),i.cancel()},fixJqueryUiDialog:function(){e(".ui-icon-closethick").attr("class","jqueryUi-closethick-fix").html("")},toggleCategoryChooser:function(e){e.preventDefault(),this.categoryChooser.toggle()},initHelp:function(e){new p({el:"body",elementName:e,indicatorName:"#shp-show",webroot:n.settings.get("webroot")})},scrollToThread:function(t){e(".threadBox[data-id="+t+"]")[0].scrollIntoView("top")},initAutoreload:function(){this.breakAutoreload(),n.settings.get("autoPageReload")&&(this.autoPageReloadTimer=setTimeout(t.bind(function(){window.location=n.settings.get("webroot")+"entries/"},this),1e3*n.settings.get("autoPageReload")))},breakAutoreload:function(){this.autoPageReloadTimer!==!1&&(clearTimeout(this.autoPageReloadTimer),this.autoPageReloadTimer=!1)},widenSearchField:function(t){var i=350;t.preventDefault(),e(t.currentTarget).width()<i&&e(t.currentTarget).animate({width:i+"px"},"fast")},showLoginForm:function(t){var i;if(!navigator.userAgent.match(/iPhone/i)&&!navigator.userAgent.match(/iPod/i)){i=e("#modalLoginDialog"),t.preventDefault(),i.height("auto");var n=t.currentTarget.title;i.dialog({modal:!0,title:n,width:420,show:"fade",hide:"fade",position:["center",120],resizable:!1})}},scrollToTop:function(e){e.preventDefault(),window.scrollTo(0,0)},manuallyMarkAsRead:function(e){e&&e.preventDefault(),this._onEntriesIndexReload(),window.redirect(n.settings.get("webroot")+"entries/update")},_onEntriesIndexReload:function(){var e=n.request.controller,t=n.request.action;"entries"===e&&"index"===t&&n.commands.execute("shoutbox:mar",{silent:!0})}});return v}),function(e){var t,i,n,o=e(window),s={jqueryui:{container:"ui-widget ui-widget-content ui-corner-all",notice:"ui-state-highlight",notice_icon:"ui-icon ui-icon-info",info:"",info_icon:"ui-icon ui-icon-info",success:"ui-state-default",success_icon:"ui-icon ui-icon-circle-check",error:"ui-state-error",error_icon:"ui-icon ui-icon-alert",closer:"ui-icon ui-icon-close",pin_up:"ui-icon ui-icon-pin-w",pin_down:"ui-icon ui-icon-pin-s",hi_menu:"ui-state-default ui-corner-bottom",hi_btn:"ui-state-default ui-corner-all",hi_btnhov:"ui-state-hover",hi_hnd:"ui-icon ui-icon-grip-dotted-horizontal"},bootstrap:{container:"alert",notice:"",notice_icon:"icon-exclamation-sign",info:"alert-info",info_icon:"icon-info-sign",success:"alert-success",success_icon:"icon-ok-sign",error:"alert-error",error_icon:"icon-warning-sign",closer:"icon-remove",pin_up:"icon-pause",pin_down:"icon-play",hi_menu:"well",hi_btn:"btn",hi_btnhov:"",hi_hnd:"icon-chevron-down"}},r=function(){n=e("body"),o=e(window),o.bind("resize",function(){i&&clearTimeout(i),i=setTimeout(e.pnotify_position_all,10)})};document.body?r():e(r),e.extend({pnotify_remove_all:function(){var t=o.data("pnotify");t&&t.length&&e.each(t,function(){this.pnotify_remove&&this.pnotify_remove()})},pnotify_position_all:function(){i&&clearTimeout(i),i=null;var t=o.data("pnotify");t&&t.length&&(e.each(t,function(){var e=this.opts.stack;e&&(e.nextpos1=e.firstpos1,e.nextpos2=e.firstpos2,e.addpos2=0,e.animation=!0)}),e.each(t,function(){this.pnotify_position()}))},pnotify:function(r){var a,l;"object"!=typeof r?(l=e.extend({},e.pnotify.defaults),l.text=r):l=e.extend({},e.pnotify.defaults,r);for(var d in l)"string"==typeof d&&d.match(/^pnotify_/)&&(l[d.replace(/^pnotify_/,"")]=l[d]);if(l.before_init&&l.before_init(l)===!1)return null;var c,h=function(t,i){f.css("display","none");var n=document.elementFromPoint(t.clientX,t.clientY);f.css("display","block");var o=e(n),s=o.css("cursor");f.css("cursor","auto"!=s?s:"default"),c&&c.get(0)==n||(c&&(u.call(c.get(0),"mouseleave",t.originalEvent),u.call(c.get(0),"mouseout",t.originalEvent)),u.call(n,"mouseenter",t.originalEvent),u.call(n,"mouseover",t.originalEvent)),u.call(n,i,t.originalEvent),c=o},p=s[l.styling],f=e("<div />",{"class":"ui-pnotify "+l.addclass,css:{display:"none"},mouseenter:function(e){l.nonblock&&e.stopPropagation(),l.mouse_reset&&"out"==a&&(f.stop(!0),a="in",f.css("height","auto").animate({width:l.width,opacity:l.nonblock?l.nonblock_opacity:l.opacity},"fast")),l.nonblock&&f.animate({opacity:l.nonblock_opacity},"fast"),l.hide&&l.mouse_reset&&f.pnotify_cancel_remove(),l.sticker&&!l.nonblock&&f.sticker.trigger("pnotify_icon").css("visibility","visible"),l.closer&&!l.nonblock&&f.closer.css("visibility","visible")},mouseleave:function(t){l.nonblock&&t.stopPropagation(),c=null,f.css("cursor","auto"),l.nonblock&&"out"!=a&&f.animate({opacity:l.opacity},"fast"),l.hide&&l.mouse_reset&&f.pnotify_queue_remove(),l.sticker_hover&&f.sticker.css("visibility","hidden"),l.closer_hover&&f.closer.css("visibility","hidden"),e.pnotify_position_all()},mouseover:function(e){l.nonblock&&e.stopPropagation()},mouseout:function(e){l.nonblock&&e.stopPropagation()},mousemove:function(e){l.nonblock&&(e.stopPropagation(),h(e,"onmousemove"))},mousedown:function(e){l.nonblock&&(e.stopPropagation(),e.preventDefault(),h(e,"onmousedown"))},mouseup:function(e){l.nonblock&&(e.stopPropagation(),e.preventDefault(),h(e,"onmouseup"))},click:function(e){l.nonblock&&(e.stopPropagation(),h(e,"onclick"))},dblclick:function(e){l.nonblock&&(e.stopPropagation(),h(e,"ondblclick"))}});f.opts=l,f.container=e("<div />",{"class":p.container+" ui-pnotify-container "+("error"==l.type?p.error:"info"==l.type?p.info:"success"==l.type?p.success:p.notice)}).appendTo(f),""!=l.cornerclass&&f.container.removeClass("ui-corner-all").addClass(l.cornerclass),l.shadow&&f.container.addClass("ui-pnotify-shadow"),f.pnotify_version="1.2.0",f.pnotify=function(t){var i=l;"string"==typeof t?l.text=t:l=e.extend({},l,t);for(var n in l)"string"==typeof n&&n.match(/^pnotify_/)&&(l[n.replace(/^pnotify_/,"")]=l[n]);return f.opts=l,l.cornerclass!=i.cornerclass&&f.container.removeClass("ui-corner-all").addClass(l.cornerclass),l.shadow!=i.shadow&&(l.shadow?f.container.addClass("ui-pnotify-shadow"):f.container.removeClass("ui-pnotify-shadow")),l.addclass===!1?f.removeClass(i.addclass):l.addclass!==i.addclass&&f.removeClass(i.addclass).addClass(l.addclass),l.title===!1?f.title_container.slideUp("fast"):l.title!==i.title&&(l.title_escape?f.title_container.text(l.title).slideDown(200):f.title_container.html(l.title).slideDown(200)),l.text===!1?f.text_container.slideUp("fast"):l.text!==i.text&&(l.text_escape?f.text_container.text(l.text).slideDown(200):f.text_container.html(l.insert_brs?String(l.text).replace(/\n/g,"<br />"):l.text).slideDown(200)),f.pnotify_history=l.history,f.pnotify_hide=l.hide,l.type!=i.type&&f.container.removeClass(p.error+" "+p.notice+" "+p.success+" "+p.info).addClass("error"==l.type?p.error:"info"==l.type?p.info:"success"==l.type?p.success:p.notice),(l.icon!==i.icon||l.icon===!0&&l.type!=i.type)&&(f.container.find("div.ui-pnotify-icon").remove(),l.icon!==!1&&e("<div />",{"class":"ui-pnotify-icon"}).append(e("<span />",{"class":l.icon===!0?"error"==l.type?p.error_icon:"info"==l.type?p.info_icon:"success"==l.type?p.success_icon:p.notice_icon:l.icon})).prependTo(f.container)),l.width!==i.width&&f.animate({width:l.width}),l.min_height!==i.min_height&&f.container.animate({minHeight:l.min_height}),l.opacity!==i.opacity&&f.fadeTo(l.animate_speed,l.opacity),!l.closer||l.nonblock?f.closer.css("display","none"):f.closer.css("display","block"),!l.sticker||l.nonblock?f.sticker.css("display","none"):f.sticker.css("display","block"),f.sticker.trigger("pnotify_icon"),l.sticker_hover?f.sticker.css("visibility","hidden"):l.nonblock||f.sticker.css("visibility","visible"),l.closer_hover?f.closer.css("visibility","hidden"):l.nonblock||f.closer.css("visibility","visible"),l.hide?i.hide||f.pnotify_queue_remove():f.pnotify_cancel_remove(),f.pnotify_queue_position(),f},f.pnotify_position=function(e){var t=f.opts.stack;if(t){t.nextpos1||(t.nextpos1=t.firstpos1),t.nextpos2||(t.nextpos2=t.firstpos2),t.addpos2||(t.addpos2=0);var i="none"==f.css("display");if(!i||e){var n,s,r,a={};switch(t.dir1){case"down":r="top";break;case"up":r="bottom";break;case"left":r="right";break;case"right":r="left"}n=parseInt(f.css(r)),isNaN(n)&&(n=0),"undefined"!=typeof t.firstpos1||i||(t.firstpos1=n,t.nextpos1=t.firstpos1);var l;switch(t.dir2){case"down":l="top";break;case"up":l="bottom";break;case"left":l="right";break;case"right":l="left"}if(s=parseInt(f.css(l)),isNaN(s)&&(s=0),"undefined"!=typeof t.firstpos2||i||(t.firstpos2=s,t.nextpos2=t.firstpos2),("down"==t.dir1&&t.nextpos1+f.height()>o.height()||"up"==t.dir1&&t.nextpos1+f.height()>o.height()||"left"==t.dir1&&t.nextpos1+f.width()>o.width()||"right"==t.dir1&&t.nextpos1+f.width()>o.width())&&(t.nextpos1=t.firstpos1,t.nextpos2+=t.addpos2+("undefined"==typeof t.spacing2?25:t.spacing2),t.addpos2=0),t.animation&&t.nextpos2<s)switch(t.dir2){case"down":a.top=t.nextpos2+"px";break;case"up":a.bottom=t.nextpos2+"px";break;case"left":a.right=t.nextpos2+"px";break;case"right":a.left=t.nextpos2+"px"}else f.css(l,t.nextpos2+"px");switch(t.dir2){case"down":case"up":f.outerHeight(!0)>t.addpos2&&(t.addpos2=f.height());break;case"left":case"right":f.outerWidth(!0)>t.addpos2&&(t.addpos2=f.width())}if(t.nextpos1)if(t.animation&&(n>t.nextpos1||a.top||a.bottom||a.right||a.left))switch(t.dir1){case"down":a.top=t.nextpos1+"px";break;case"up":a.bottom=t.nextpos1+"px";break;case"left":a.right=t.nextpos1+"px";break;case"right":a.left=t.nextpos1+"px"}else f.css(r,t.nextpos1+"px");switch((a.top||a.bottom||a.right||a.left)&&f.animate(a,{duration:500,queue:!1}),t.dir1){case"down":case"up":t.nextpos1+=f.height()+("undefined"==typeof t.spacing1?25:t.spacing1);break;case"left":case"right":t.nextpos1+=f.width()+("undefined"==typeof t.spacing1?25:t.spacing1)}}}},f.pnotify_queue_position=function(t){i&&clearTimeout(i),t||(t=10),i=setTimeout(e.pnotify_position_all,t)},f.pnotify_display=function(){f.parent().length||f.appendTo(n),l.before_open&&l.before_open(f)===!1||("top"!=l.stack.push&&f.pnotify_position(!0),"fade"==l.animation||"fade"==l.animation.effect_in?f.show().fadeTo(0,0).hide():1!=l.opacity&&f.show().fadeTo(0,l.opacity).hide(),f.animate_in(function(){l.after_open&&l.after_open(f),f.pnotify_queue_position(),l.hide&&f.pnotify_queue_remove()}))},f.pnotify_remove=function(){f.timer&&(window.clearTimeout(f.timer),f.timer=null),l.before_close&&l.before_close(f)===!1||f.animate_out(function(){l.after_close&&l.after_close(f)===!1||(f.pnotify_queue_position(),l.remove&&f.detach())})},f.animate_in=function(e){a="in";var t;t="undefined"!=typeof l.animation.effect_in?l.animation.effect_in:l.animation,"none"==t?(f.show(),e()):"show"==t?f.show(l.animate_speed,e):"fade"==t?f.show().fadeTo(l.animate_speed,l.opacity,e):"slide"==t?f.slideDown(l.animate_speed,e):"function"==typeof t?t("in",e,f):f.show(t,"object"==typeof l.animation.options_in?l.animation.options_in:{},l.animate_speed,e)},f.animate_out=function(e){a="out";var t;t="undefined"!=typeof l.animation.effect_out?l.animation.effect_out:l.animation,"none"==t?(f.hide(),e()):"show"==t?f.hide(l.animate_speed,e):"fade"==t?f.fadeOut(l.animate_speed,e):"slide"==t?f.slideUp(l.animate_speed,e):"function"==typeof t?t("out",e,f):f.hide(t,"object"==typeof l.animation.options_out?l.animation.options_out:{},l.animate_speed,e)},f.pnotify_cancel_remove=function(){f.timer&&window.clearTimeout(f.timer)},f.pnotify_queue_remove=function(){f.pnotify_cancel_remove(),f.timer=window.setTimeout(function(){f.pnotify_remove()},isNaN(l.delay)?0:l.delay)},f.closer=e("<div />",{"class":"ui-pnotify-closer",css:{cursor:"pointer",visibility:l.closer_hover?"hidden":"visible"},click:function(){f.pnotify_remove(),f.sticker.css("visibility","hidden"),f.closer.css("visibility","hidden")}}).append(e("<span />",{"class":p.closer})).appendTo(f.container),(!l.closer||l.nonblock)&&f.closer.css("display","none"),f.sticker=e("<div />",{"class":"ui-pnotify-sticker",css:{cursor:"pointer",visibility:l.sticker_hover?"hidden":"visible"},click:function(){l.hide=!l.hide,l.hide?f.pnotify_queue_remove():f.pnotify_cancel_remove(),e(this).trigger("pnotify_icon")}}).bind("pnotify_icon",function(){e(this).children().removeClass(p.pin_up+" "+p.pin_down).addClass(l.hide?p.pin_up:p.pin_down)}).append(e("<span />",{"class":p.pin_up})).appendTo(f.container),(!l.sticker||l.nonblock)&&f.sticker.css("display","none"),l.icon!==!1&&e("<div />",{"class":"ui-pnotify-icon"}).append(e("<span />",{"class":l.icon===!0?"error"==l.type?p.error_icon:"info"==l.type?p.info_icon:"success"==l.type?p.success_icon:p.notice_icon:l.icon})).prependTo(f.container),f.title_container=e("<h4 />",{"class":"ui-pnotify-title"}).appendTo(f.container),l.title===!1?f.title_container.hide():l.title_escape?f.title_container.text(l.title):f.title_container.html(l.title),f.text_container=e("<div />",{"class":"ui-pnotify-text"}).appendTo(f.container),l.text===!1?f.text_container.hide():l.text_escape?f.text_container.text(l.text):f.text_container.html(l.insert_brs?String(l.text).replace(/\n/g,"<br />"):l.text),"string"==typeof l.width&&f.css("width",l.width),"string"==typeof l.min_height&&f.container.css("min-height",l.min_height),f.pnotify_history=l.history,f.pnotify_hide=l.hide;var m=o.data("pnotify");if((null==m||"object"!=typeof m)&&(m=[]),m="top"==l.stack.push?e.merge([f],m):e.merge(m,[f]),o.data("pnotify",m),"top"==l.stack.push&&f.pnotify_queue_position(1),l.after_init&&l.after_init(f),l.history){var g=o.data("pnotify_history");if("undefined"==typeof g){g=e("<div />",{"class":"ui-pnotify-history-container "+p.hi_menu,mouseleave:function(){g.animate({top:"-"+t+"px"},{duration:100,queue:!1})}}).append(e("<div />",{"class":"ui-pnotify-history-header",text:"Redisplay"})).append(e("<button />",{"class":"ui-pnotify-history-all "+p.hi_btn,text:"All",mouseenter:function(){e(this).addClass(p.hi_btnhov)},mouseleave:function(){e(this).removeClass(p.hi_btnhov)},click:function(){return e.each(m,function(){this.pnotify_history&&(this.is(":visible")?this.pnotify_hide&&this.pnotify_queue_remove():this.pnotify_display&&this.pnotify_display())}),!1}})).append(e("<button />",{"class":"ui-pnotify-history-last "+p.hi_btn,text:"Last",mouseenter:function(){e(this).addClass(p.hi_btnhov)},mouseleave:function(){e(this).removeClass(p.hi_btnhov)},click:function(){var e,t=-1;do{if(e=-1==t?m.slice(t):m.slice(t,t+1),!e[0])break;t--}while(!e[0].pnotify_history||e[0].is(":visible"));return e[0]?(e[0].pnotify_display&&e[0].pnotify_display(),!1):!1}})).appendTo(n);var b=e("<span />",{"class":"ui-pnotify-history-pulldown "+p.hi_hnd,mouseenter:function(){g.animate({top:"0"},{duration:100,queue:!1})}}).appendTo(g);t=b.offset().top+2,g.css({top:"-"+t+"px"}),o.data("pnotify_history",g)}}return l.stack.animation=!1,f.pnotify_display(),f}});var a=/^on/,l=/^(dbl)?click$|^mouse(move|down|up|over|out|enter|leave)$|^contextmenu$/,d=/^(focus|blur|select|change|reset)$|^key(press|down|up)$/,c=/^(scroll|resize|(un)?load|abort|error)$/,u=function(t,i){var n;if(t=t.toLowerCase(),document.createEvent&&this.dispatchEvent){if(t=t.replace(a,""),t.match(l)?(e(this).offset(),n=document.createEvent("MouseEvents"),n.initMouseEvent(t,i.bubbles,i.cancelable,i.view,i.detail,i.screenX,i.screenY,i.clientX,i.clientY,i.ctrlKey,i.altKey,i.shiftKey,i.metaKey,i.button,i.relatedTarget)):t.match(d)?(n=document.createEvent("UIEvents"),n.initUIEvent(t,i.bubbles,i.cancelable,i.view,i.detail)):t.match(c)&&(n=document.createEvent("HTMLEvents"),n.initEvent(t,i.bubbles,i.cancelable)),!n)return;this.dispatchEvent(n)}else t.match(a)||(t="on"+t),n=document.createEventObject(i),this.fireEvent(t,n)};e.pnotify.defaults={title:!1,title_escape:!1,text:!1,text_escape:!1,styling:"bootstrap",addclass:"",cornerclass:"",nonblock:!1,nonblock_opacity:.2,history:!0,width:"300px",min_height:"16px",type:"notice",icon:!0,animation:"fade",animate_speed:"slow",opacity:1,shadow:!0,closer:!0,closer_hover:!0,sticker:!0,sticker_hover:!0,hide:!0,delay:8e3,mouse_reset:!0,remove:!0,insert_brs:!0,stack:{dir1:"down",dir2:"left",push:"bottom",spacing1:25,spacing2:25}}}(jQuery),define("views/../../dev/vendors/pnotify/jquery.pnotify",function(){}),define("views/notification",["jquery","underscore","backbone","models/app","../../dev/vendors/pnotify/jquery.pnotify"],function(e,t,i,n){"use strict";var o=i.View.extend({initialize:function(){this.listenTo(n.eventBus,"notification",this._showMessages),this.listenTo(n.eventBus,"notificationUnset",this._unset)},_showMessages:function(e){if(void 0!==e){if(void 0===e.msg){if(void 0===e.message)return;e={msg:[e]}}else if(0===e.msg.length)return;t.each(e.msg,function(e){this._showMessage(e)},this)}},_showMessage:function(t){switch(t.channel=t.channel||"notification",t.message=e.i18n.__(t.message.trim()),t.channel){case"form":this._form(t);break;case"popover":this._popover(t);break;default:this._showNotification(t)}},_unset:function(t){"all"===t&&e(".error-message").remove()},_form:function(i){var n;n=t.template('<div class="error-message"><%= message %></div>'),e(i.element).after(n({message:i.message}))},_showNotification:function(t){var i,n;switch(n=5e3,i={title:t.title,text:t.message,icon:!1,history:!1,addclass:"flash",delay:n},t.type){case"success":i.addclass+=" flash-success";break;case"warning":i.addclass+=" flash-warning";break;case"error":i.addclass+=" flash-error",i.delay=2*n;break;default:i.addclass+=" flash-notice"}e.pnotify(i)}});return o}),define("views/prerequisitesTester",["jquery","marionette","models/app"],function(e,t,i){"use strict";var n=t.ItemView.extend({_warningTpl:_.template('<div class="app-prerequisites-warning"> <%- warning %> </div>'),initialize:function(){this._testLocalStorage()},_testLocalStorage:function(){i.reqres.request("app:localStorage:available")||this._addWarning(e.i18n.__("This web-application depends on Cookies and localStorage. Please make those available in your browser."))},_addWarning:function(e){this.$el.append(this._warningTpl({warning:e}))}});return n}),define("lib/leaflet/mq",[],function(){return"undefined"!=typeof MQ?MQ:void 0}),define("text!modules/usermap/templates/controls.html",[],function(){return'<div class="input">\n    <% if (lat) { %>\n        <div class="saito-usermap-info infoText">\n            <%= lat %>, <%= lng %>, <%= zoom %>\n        </div>\n    <% } %>\n    <button class="btn js-btn-search">–</button>\n    <% if (geolocation) { %>\n        <button class="btn js-btn-locate"><%- $.i18n.__(\'user.map.b.locate\') %></button>\n    <% } %>\n    <button class="btn js-btn-clear"><%- $.i18n.__(\'user.map.b.clear\') %></button>\n    <i class="saito-usermap-spinner fa fa-cog fa-spin" style="display: none;"></i>\n</div>'}),define("modules/usermap/views/controls",["jquery","marionette","lib/leaflet/mq","text!modules/usermap/templates/controls.html"],function(e,t,i,n){"use strict";return t.ItemView.extend({template:_.template(n),ui:{search:".js-btn-search",locate:".js-btn-locate",clear:".js-btn-clear",spinner:".saito-usermap-spinner"},events:{"click @ui.search":"_search","click @ui.locate":"_locate","click @ui.clear":"_clear"},initialize:function(t){this.mapLayer=t.mapLayer,this.mapModel=t.mapModel,this.params=t.params,this.mapLayer.on("click",this._repin,this),this.mapLayer.on("locationfound",this._repin,this),e(this.params.fields.edit).on("keypress",_.bind(this._onSearchFieldChange,this)),e(this.params.fields.edit).on("keyup",_.bind(this._updateSearchButtonTitle,this))},_clear:function(e){e.preventDefault(),this.model.set({lat:"",lng:"",zoom:""}),this._updateFields()},_search:function(t){t.preventDefault(),this._activityStart();var n=e(this.params.fields.edit).val();i.geocode().search(n).on("success",_.bind(function(e){var t=e.result.best;this._repin(t)},this))},_onSearchFieldChange:function(e){13===e.which&&this._search(e)},_activityStart:function(){this.ui.spinner.show()},_activityStop:function(){this.ui.spinner.hide()},_updateSearchButtonTitle:function(){var t=e(this.params.fields.edit).val();return t?(this.ui.search.removeAttr("disabled"),void this.ui.search.html(e.i18n.__("user.map.b.search",{string:t}))):void this.ui.search.attr("disabled","disabled")},_locate:function(e){e.preventDefault(),this._activityStart(),this.mapLayer.locate()},_repin:function(e){var t=this._round({lat:e.latlng.lat,lng:e.latlng.lng,zoom:this.mapLayer.getZoom()});this._activityStop(),this.model.set(t),this.mapModel.set(t),this._updateFields()},_round:function(e){return _.each(["lat","lng"],function(t){e[t]=e[t].toFixed(4)}),e},onRender:function(){this._updateSearchButtonTitle()},_updateFields:function(){var t=this.params.fields.update,i=this.model;_.each(["lat","lng","zoom"],_.bind(function(n){var o=n;t&&t[n]&&_.each(t[n],function(t){var n=e(t),s=i.get(o);"input"===n.prop("tagName").toLowerCase()?n.val(s):n.html(s)})},this)),this.render()},_geolocation:function(){return"geolocation"in navigator},serializeData:function(){var e=this.model.toJSON();return e.geolocation=this._geolocation(),e}})}),define("lib/leaflet/leaflet",[],function(){return"undefined"!=typeof L?L:void 0}),define("modules/usermap/views/map",["marionette","templateHelpers","lib/leaflet/leaflet","lib/leaflet/mq"],function(e,t,i,n){"use strict";return e.ItemView.extend({collectionEvents:{add:"_createMarker",change:"_repinMarker"},modelEvents:{"change:lat":"_setView"},template:{},templateHelpers:t,mapLayer:null,markersLayer:null,markers:{},initialize:function(){"world"===this.model.get("type")&&this._zoomView(),this.markersLayer=new i.MarkerClusterGroup,this._map()},_zoomView:function(){var e=40,t=$("#content"),i={width:t.width(),top:t.offset().top},n={height:i.width*(120/198)},o={height:$(window).height()};o.available=o.height-i.top,n.height>o.available&&(n.height=o.available-e),this.$el.height(n.height)},_createMarker:function(e){var t,n=e.latlng(),o=i.marker(n);if(n[0]){if(e){var s=this.templateHelpers.User.linkToUserProfile(e.get("id"),e.get("name"));o.bindPopup(s)}if(this.markersLayer.addLayer(o),this.markers[e.get("id")]=o,t=this.model.get("type"),"single"===t||"edit"===t){var r={lat:e.get("lat"),lng:e.get("lng")};r.zoom="edit"===t?e.get("zoom"):this.model.get("maxZoom"),this.model.set(r)}}},_repinMarker:function(e){if(!e.get("lat"))return void this._clearMarkers();var t=this.markers[e.get("id")];if(!t)return void this._createMarker(e);var i=t.getLatLng();i.lat=e.get("lat"),i.lng=e.get("lng"),t.update()},_clearMarkers:function(){this.markers={},this.markersLayer.clearLayers()},_setView:function(){var e=this.model.get("lat"),t=this.model.get("lng"),i=this.model.get("zoom");this.mapLayer.setView([e,t],i)},_map:function(){var e=n.mapLayer();this.mapLayer=i.map(this.el,{closePopupOnClick:!1,maxZoom:this.model.get("maxZoom"),minZoom:this.model.get("minZoom"),maxBounds:this.model.get("maxBounds")}),this._setView(),this.mapLayer.addLayer(e),this.mapLayer.addLayer(this.markersLayer)}})}),define("modules/usermap/models/map",["backbone"],function(e){"use strict";var t=e.Model.extend({maxZoom:{edit:14,single:11,world:11},defaults:{lat:30,lng:0,zoom:2,maxZoom:11,minZoom:1,maxBounds:[[-90,-180],[90,180]]},initialize:function(){this.maxZoom[this.get("type")]&&this.set("maxZoom",this.maxZoom[this.get("type")])}});return t}),define("modules/usermap/models/user",["backbone"],function(e){"use strict";var t=e.Model.extend({latlng:function(){return[this.get("lat"),this.get("lng")]}});return t}),define("modules/usermap/collections/users",["backbone","modules/usermap/models/user"],function(e,t){"use strict";var i=e.Collection.extend({model:t});return i}),define("text!modules/usermap/templates/layout.html",[],function(){return"<div>\n    <div class='saito-usermap-map'></div>\n    <div class='saito-usermap-controls'></div>\n</div>"}),define("modules/usermap/usermap",["app/core","marionette","modules/usermap/views/controls","modules/usermap/views/map","modules/usermap/models/map","modules/usermap/collections/users","text!modules/usermap/templates/layout.html"],function(e,t,i,n,o,s,r){"use strict";var a=e.module("usermap",{startWithParent:!1});return a.addInitializer(function(){var e=$(".saito-usermap");if(e.length){var l,d,c=e.data("users"),u=new s,h=e.data("params"),p=t.Layout.extend({el:e,template:r,regions:{mapr:".saito-usermap-map",controls:".saito-usermap-controls"}}),f=(new p).render(),m=new o(h);d=new n({el:f.$(".saito-usermap-map"),model:m,collection:u}),u.add(c),"edit"===h.type&&(d.$el.addClass("input"),l=a.ControlView=new i({model:u.at(0),mapLayer:d.mapLayer,mapModel:m,params:h}),f.controls.show(l))}}),a}),define("app/time",["moment","moment-de"],function(e){"use strict";var t=e().lang()._longDateFormat;t.LT="H:mm",e.lang("de",{longDateFormat:t})}),define("lib/Saito/isAppVisible",["jquery","underscore","models/app"],function(e,t,i){"use strict";var n=function(){this.initialize.apply(this,arguments)};return t.extend(n.prototype,{_isVisibleOldSchool:!0,initialize:function(){i.reqres.setHandler("isAppVisible",this.isVisible,this),this._isVisibleOldSchool=this._isAppVisibleHtml5(),this._initAppVisibleOldSchool()},isVisible:function(){return this._isVisibleOldSchool},_initAppVisibleOldSchool:function(){e(window).blur(t.bind(function(){this._isVisibleOldSchool=!1},this)),e(window).focus(t.bind(function(){this._isVisibleOldSchool=!0},this))},_isAppVisibleHtml5:function(){var e,t=!1;return"undefined"!=typeof document.hidden?e="hidden":"undefined"!=typeof document.webkitHidden&&(e="webkitHidden"),document[e]&&(t=document[e]),!t}}),new n}),function(e){e.i18n={dict:null,setDictionary:function(e){this.dict=e},_:function(e,t){var i=e;return this.dict&&this.dict[e]&&(i=this.dict[e]),this.printf(i,t)},printf:function(e,t){if(!t)return e;for(var i="",n=/%(\d+)\$s/g,o=n.exec(e);o;){var s=parseInt(o[1],10)-1;e=e.replace("%"+o[1]+"$s",t[s]),o=n.exec(e)}var r=e.split("%s");if(r.length>1)for(var a=0;a<t.length;a++)r[a].length>0&&r[a].lastIndexOf("%")==r[a].length-1&&(r[a]+="s"+r.splice(a+1,1)[0]),i+=r[a]+t[a];return i+r[r.length-1]}},e.fn._t=function(t,i){return e(this).text(e.i18n._(t,i))}}(jQuery),define("lib/jquery.i18n/jquery.i18n",function(){}),define("lib/jquery.i18n/jquery.i18n.extend",["jquery","lib/jquery.i18n/jquery.i18n"],function(e){"use strict";e.extend(e.i18n,{currentString:"",setDict:function(e){this.dict=e},setUrl:function(e){this.dictUrl=e,this._loadDict()},_loadDict:function(){return e.ajax({url:this.dictUrl,dataType:"json",async:!1,cache:!0,success:e.proxy(function(e){this.dict=e},this)})},__:function(e,t){var i=e;return"object"==typeof this.dict[e]&&""!==this.dict[e][""]&&(i=this.dict[e][""]),"object"==typeof t&&(i=this._insert(i,t)),i},_insert:function(e,t){return e.replace(/:([-\w]+)/g,function(e,i){return"undefined"!=typeof t[i]?t[i]:e})}})}),function(e,t){"function"==typeof define&&define.amd?define("lib/saito/backbone.initHelper",["underscore","backbone"],function(i,n){return t(i||e._,n||e.Backbone)}):t(_,Backbone)}(this,function(e,t){t.View.prototype.initCollectionFromDom=function(e,t,i){var n=function(e,t,n){e.add({id:t}),new i({el:n,model:e.get(t),collection:e})};$(e).each(function(){n(t,$(this).data("id"),this)})}}),define("app/app",["marionette","app/core","app/vent","modules/html5-notification/html5-notification"],function(e,t,i){var n=SaitoApp,o=function(e){require(["jquery","domReady"],function(t,i){t.isReady?e():i(function(){e()})})},s={fireOnPageCallbacks:function(e){var t=e.afterAppInit;_.each(t,function(e){e()}),i.vent.on("isAppVisible",_.once(function(){var t=e.afterViewInit;_.each(t,function(e){e()})}))},bootstrapShoutbox:function(){o(function(){require(["modules/shoutbox/shoutbox"],function(e){e.start()})})},bootstrapApp:function(e){require(["domReady","views/app","backbone","jquery","models/app","views/notification","views/prerequisitesTester","modules/html5-notification/html5-notification","modules/usermap/usermap","app/time","lib/Saito/isAppVisible","lib/jquery.i18n/jquery.i18n.extend","jqueryDropdown","lib/saito/backbone.initHelper","lib/saito/backbone.modelHelper","fastclick"],function(t,i,r,a,l,d,c,u,h){var p,f,m;l.settings.set(e.SaitoApp.app.settings),a.i18n.setUrl(l.settings.get("webroot")+"da/langJs"),l.currentUser.set(e.SaitoApp.currentUser),l.request=e.SaitoApp.request,u.start(),h.start(),new d;var g=e.SaitoApp.callbacks.beforeAppInit;_.each(g,function(e){e()}),window.addEventListener("load",function(){new FastClick(document.body)},!1),m=new c({el:a(".app-prerequisites-warnings")}),p=new i,f=function(){"shouts"in n&&s.bootstrapShoutbox(),s.fireOnPageCallbacks(e.SaitoApp.callbacks),p.initFromDom({SaitoApp:e.SaitoApp,contentTimer:e.contentTimer})},o(f)})}},r=t;return r.addInitializer(s.bootstrapApp),r.start({contentTimer:contentTimer,SaitoApp:n}),i.reqres.setHandler("webroot",function(){return n.app.settings.webroot}),i.reqres.setHandler("apiroot",function(){return n.app.settings.webroot+"api/v1/"}),r}),require.config({paths:{common:"../dist/common.min",templateHelpers:"lib/saito/templateHelpers"}}),function(e){"use strict";e.contentTimer={show:function(){$("#content").css("visibility","visible"),console.warn("DOM ready timed out: show content fallback used."),delete this.timeoutID},setup:function(){this.cancel();var t=this;this.timeoutID=e.setTimeout(function(){t.show()},5e3)},cancel:function(){"number"==typeof this.timeoutID&&(e.clearTimeout(this.timeoutID),delete this.timeoutID)}},e.contentTimer.setup()}(window),require(["lib/bootstrapHelper","common"],function(){"use strict";require(["lib/saito/underscore.extend"]),require(["app/app"])}),define("main",function(){});